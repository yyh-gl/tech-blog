<!doctype html><html lang=ja><head><meta charset=utf-8><title>【Golang+VCR】外部APIとの通信を保存してテストに使用する話 - yyh-gl's Tech Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/tech-blog/favicon/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/tech-blog/favicon/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/tech-blog/favicon/favicon-16x16.png?v=1"><link rel=manifest href="/tech-blog/favicon/site.webmanifest?v=1"><link rel=mask-icon href="/tech-blog/favicon/safari-pinned-tab.svg?v=1" color=#ffffff><link rel="shortcut icon" href="/tech-blog/favicon/favicon.ico?v=1"><meta name=msapplication-config content="/tech-blog/favicon/browserconfig.xml?v=1"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.77.0"><meta property="og:site_name" content="yyh-gl's Tech Blog"><meta property="og:title" content="【Golang+VCR】外部APIとの通信を保存してテストに使用する話"><meta property="og:description" content="Go3 Advent Calendar 2019 8日目"><meta property="description" content="Go3 Advent Calendar 2019 8日目"><meta property="og:url" content="https://yyh-gl.github.io/tech-blog/blog/golang-vcr/"><meta property="og:type" content="article"><meta property="og:image" content="https://yyh-gl.github.io/tech-blog/img/main/logo.png"><link rel=stylesheet href=/tech-blog/css/bundle.min.aa948a74998e9ef220fef5691836b736569ef4b19c4372636ac19d0281aeac2d.css integrity="sha256-qpSKdJmOnvIg/vVpGDa3Nlae9LGcQ3JjasGdAoGurC0="><link rel=stylesheet href=/tech-blog/css/add-on.css><script src=https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js></script><script src=/tech-blog/js/vue.min.js></script><script src=/tech-blog/js/good-counter.js defer></script></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/tech-blog/ class=nav>Blog</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/tech-blog/ class="nav link"><i class="fa fa-home"></i>Home</a>
<a href=/tech-blog/about/ class="nav link"><i class="far fa-id-card"></i>About</a>
<a href=/tech-blog/blog/ class="nav link"><i class="far fa-newspaper"></i>Blog</a>
<a href=/tech-blog/categories/ class="nav link"><i class="fas fa-sitemap"></i>Categories</a></menu>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav></header><div id=wrapper><section id=site-intro><a href=/tech-blog/><img src=https://yyh-gl.github.io/tech-blog/img/main/logo.png class=circle width=80 alt="yyh-gl's icon"></a><header><h1>yyh-gl's Tech Blog</h1></header><main><p>技術ネタ中心のブログです。主な扱いはバックエンド技術と設計です。</p></main><footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/tech-blog/blog/golang-vcr/>【Golang+VCR】外部APIとの通信を保存してテストに使用する話</a></h2><p>Go3 Advent Calendar 2019 8日目</p></div><div class=meta><time datetime="2019-12-08 00:00:00 +0000 UTC">2019-12-08</time><p>yyh-gl</p><p>7 分で読めます</p></div></header><div id=socnet-share></div><div class=content><a href=/tech-blog/blog/golang-vcr/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/12/golang-vcr/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/12/golang-vcr/featured.png alt=画像がどこかへ逝ってしまったようだ…></a><br><hr><h1 id=go3-advent-calendar-2019>Go3 Advent Calendar 2019</h1><hr><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/12/react_typescript_sample/qiita_advent_calendar_2019.png width=700><p>本記事は <a href=https://qiita.com/advent-calendar/2019/go3>Go3 Advent Calendar 2019</a> の 8日目 の記事です。</p><p>ではでは、早速本題に入っていきます。</p><br><hr><h1 id=モック使ってますか>モック使ってますか？</h1><hr><p>みなさんモックコードは書いていますか？</p><p>テストコードを書いているなら、ほぼ必ず登場するあのモックです。<br>DB処理や関数のモックなどいろいろありますよね。</p><p>そんなモックコードですが、作ったり管理するのめんどくさいなぁとか思ってないですか？<br>モックだからといって雑なコードになっていませんか？</p><br><p>今回は、外部API通信のモック化にフォーカスし、<br>モックコードの作成・管理コストを軽減する<br><u>VCR ライブラリ</u> を紹介します。</p><br><hr><h1 id=vcr-ライブラリ-とは>VCR ライブラリ とは？</h1><hr><p>VCR（Video Cassette Recorder）とは、<u>通信を保存し、再生するライブラリ</u>です。<br></p><p>つまり、APIリクエストの初回通信の内容を保存し、<br>次回以降その保存内容（レスポンス）を使いまわしてくれるというものです。</p><p>言い換えれば、外部APIのモックを自動生成してくれるということですね！</p><br><h2 id=vcr-ライブラリ-in-golang-world>VCR ライブラリ in Golang World</h2><p>Golang 用の VCR ライブラリは<a href="https://github.com/search?l=Go&q=vcr&type=Repositories">いろいろあります</a>。<br>スター数が多いのは以下のものです。</p><ul><li><a href=https://github.com/dnaeon/go-vcr>go-vcr</a></li><li><a href=https://github.com/ComboStrikeHQ/vcr-go>vcr-go</a></li><li><a href=https://github.com/seborama/govcr>govcr</a></li><li><a href=https://github.com/googleapis/google-cloud-go/tree/master/rpcreplay>rpcreplay</a></li></ul><p>go-vcr および vcr-go，govcr の開発は盛んではないようです。</p><p>rpcreplay は <a href=https://github.com/googleapis/google-cloud-go>google-cloud-go</a>に包含されるパッケージであり、安心して使えそうです。<br>ただし、gRPC 用なので、その点は注意が必要です。<br><a href=https://godoc.org/cloud.google.com/go/rpcreplay>GoDocはこちら</a>です。</p><br><p>今回は REST API を使って説明していくので、go-vcr を使用します。<br></p><p>go-vcr は、vcr-go と govcr よりスター数が多いです。<br>Ruby 製の <a href=https://github.com/vcr/vcr>vcr</a> というライブラリがもとになっているようです。</p><br><hr><h1 id=サンプルを見ていく>サンプルを見ていく</h1><hr><p>では、コードを交えて紹介していきたいと思います。<br>今回は下記のような簡単なサンプルを用意しました。</p><p>（最終的なサンプルコードは<a href=https://github.com/yyh-gl/go-vcr-sample>こちら</a>にあります。）</p><p>Qiitaのユーザ情報取得APIを呼び出し、<br>レスポンス内容（ID と Location のみ）を表示するだけの簡単なプログラムです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /main.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>	<span style=color:#e6db74>&#34;github.com/yyh-gl/go-vcr-sample/qiita&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiita</span>.<span style=color:#a6e22e>FetchUser</span>(<span style=color:#e6db74>&#34;yyh-gl&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;============ RESULT ============&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%+v\n&#34;</span>, <span style=color:#a6e22e>user</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;============ RESULT ============&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /qiita/qiita.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>qiita</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>	<span style=color:#a6e22e>ID</span>       <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#a6e22e>Location</span> <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>user</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>User</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;https://qiita.com/api/v2/users/&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>id</span>, <span style=color:#66d9ef>nil</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>	<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>body</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>user</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>}
</code></pre></div><p>実行してみると、、、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>$ go run main.go
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#f92672>============</span> RESULT <span style=color:#f92672>============</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>&amp;<span style=color:#f92672>{</span>ID:yyh-gl Location:Tokyo, Japan<span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span style=color:#f92672>============</span> RESULT <span style=color:#f92672>============</span>
</code></pre></div><p>ちゃんと ID と Location が表示できていますね。</p><br><hr><h1 id=テストしたい>テストしたい</h1><hr><p>今回のサンプルは簡単なコードですがテストを書くことにします。</p><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/12/golang-vcr/test-lion.jpeg width=600><p>・<br>・<br>・<br></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /qiita/qiita_test.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>qiita_test</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;testing&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>	<span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	<span style=color:#e6db74>&#34;github.com/yyh-gl/go-vcr-sample/qiita&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_FetchUser</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>		<span style=color:#a6e22e>testCase</span>     <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>		<span style=color:#a6e22e>id</span>           <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>		<span style=color:#a6e22e>wantLocation</span> <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>	}{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>		{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>			<span style=color:#a6e22e>testCase</span>:     <span style=color:#e6db74>&#34;Qiitaからyyh-glのユーザ情報を取得できていること&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>			<span style=color:#a6e22e>id</span>:           <span style=color:#e6db74>&#34;yyh-gl&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>			<span style=color:#a6e22e>wantLocation</span>: <span style=color:#e6db74>&#34;Tokyo, Japan&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>		},
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>testCase</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>			<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiita</span>.<span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>id</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>			<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantLocation</span>, <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Location</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>		})
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>}
</code></pre></div><p>書きました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>$ go test ./...
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>?   	github.com/yyh-gl/go-vcr-sample	<span style=color:#f92672>[</span>no test files<span style=color:#f92672>]</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>ok  	github.com/yyh-gl/go-vcr-sample/qiita	0.313s
</code></pre></div><p>ちゃんとテストが通りますね。</p><p>しかし、このままではテストのたびに<br>Qiita API にリクエストが飛んでしまうので良くないですね。</p><p>ここで、本日の主役 go-vcr を導入していきましょう。</p><br><hr><h1 id=go-vcr-のセットアップ>go-vcr のセットアップ</h1><hr><p>VCR ライブラリは通信内容を保存します。<br>つまり、通信を傍受する必要があります。</p><p>go-vcr では、http.Client の Transport を go-vcr で用意されたものに差し替えることで、<br>通信の傍受を可能にします。</p><p>したがって、まずは独自の http.Client を差し込めるように、<br>サンプルのコードを修正していきます。</p><br><h2 id=qiita-api-用の-http-クライアントを作る>Qiita API 用の HTTP クライアントを作る</h2><p>まず、<code>qiita.go</code> に HTTP クライアント生成関数を作ります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /qiita/qiita.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>qiita</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Client</span> <span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>) <span style=color:#a6e22e>Client</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Client</span>{<span style=color:#a6e22e>c</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>	<span style=color:#a6e22e>ID</span>       <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>	<span style=color:#a6e22e>Location</span> <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>Client</span>) <span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>user</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>User</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;https://qiita.com/api/v2/users/&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>id</span>, <span style=color:#66d9ef>nil</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>) <span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span style=color:#75715e></span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span>	<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>body</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>user</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span>}
</code></pre></div><br><p><code>main.go</code> と <code>qiita_test.go</code> も直します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /main.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	<span style=color:#e6db74>&#34;github.com/yyh-gl/go-vcr-sample/qiita&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#75715e></span>	<span style=color:#a6e22e>qiitaClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiita</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiitaClient</span>.<span style=color:#a6e22e>FetchUser</span>(<span style=color:#e6db74>&#34;yyh-gl&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;============ RESULT ============&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%+v\n&#34;</span>, <span style=color:#a6e22e>user</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;============ RESULT ============&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /qiita/qiita_test.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>qiita_test</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#e6db74>&#34;testing&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	<span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>	<span style=color:#e6db74>&#34;github.com/yyh-gl/go-vcr-sample/qiita&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_FetchUser</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>	<span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>		<span style=color:#a6e22e>testCase</span>     <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>		<span style=color:#a6e22e>id</span>           <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>		<span style=color:#a6e22e>wantLocation</span> <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>	}{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>		{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>			<span style=color:#a6e22e>testCase</span>:     <span style=color:#e6db74>&#34;Qiitaからyyh-glのユーザ情報を取得できていること&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>			<span style=color:#a6e22e>id</span>:           <span style=color:#e6db74>&#34;yyh-gl&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>			<span style=color:#a6e22e>wantLocation</span>: <span style=color:#e6db74>&#34;Tokyo, Japan&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>		},
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>    <span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:#75715e></span>	<span style=color:#a6e22e>qiitaClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiita</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>testCase</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>			<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiitaClient</span>.<span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>id</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span>			<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantLocation</span>, <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Location</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span>		})
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span>}
</code></pre></div><p>この状態でテストを実行すると、、、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>$ go test ./...
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>?   	github.com/yyh-gl/go-vcr-sample	<span style=color:#f92672>[</span>no test files<span style=color:#f92672>]</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>ok  	github.com/yyh-gl/go-vcr-sample/qiita	0.293s
</code></pre></div><p>ちゃんと通りますね。</p><p>さて、これで <code>NewClient()</code> に渡す引数（http.Client）しだいで、<br>使用する HTTP クライアント変更できるようになりました。</p><br><h2 id=go-vcr-導入>go-vcr 導入</h2><p>ここから go-vcr を導入して、外部APIとの通信を保存・再生していくのですが、<br><u>めちゃくちゃ簡単</u>です。</p><p>今回はテストにおいて、外部APIとの通信部分をモック化したいので、<br><code>qiita_test.go</code> を直していきます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /qiita_test.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>qiita_test</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#e6db74>&#34;testing&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	<span style=color:#e6db74>&#34;github.com/dnaeon/go-vcr/recorder&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>	<span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>	<span style=color:#e6db74>&#34;github.com/yyh-gl/go-vcr-sample/qiita&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_FetchUser</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>	<span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>		<span style=color:#a6e22e>testCase</span>     <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>		<span style=color:#a6e22e>id</span>           <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>		<span style=color:#a6e22e>wantLocation</span> <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>	}{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>		{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>			<span style=color:#a6e22e>testCase</span>:     <span style=color:#e6db74>&#34;Qiitaからyyh-glのユーザ情報を取得できていること&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>			<span style=color:#a6e22e>id</span>:           <span style=color:#e6db74>&#34;yyh-gl&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>			<span style=color:#a6e22e>wantLocation</span>: <span style=color:#e6db74>&#34;Tokyo, Japan&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>		},
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>    <span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span style=color:#75715e></span>	<span style=color:#75715e>// go-vcr のレコーダを生成
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span style=color:#75715e></span>	<span style=color:#75715e>// 通信内容は ../fixtures/qiita に保存される
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>recorder</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;../fixtures/qiita&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Stop</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span>	<span style=color:#a6e22e>customHTTPClient</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>		<span style=color:#a6e22e>Transport</span>: <span style=color:#a6e22e>r</span>, <span style=color:#75715e>// ここ 重要！
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span style=color:#75715e></span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span>	<span style=color:#a6e22e>qiitaClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiita</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>customHTTPClient</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>testCase</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span>			<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiitaClient</span>.<span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>id</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span>			<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantLocation</span>, <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Location</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span>		})
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span>}
</code></pre></div><p>以上で終了です。</p><p>この状態で <code>$ go test ./...</code> してみると、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>$ go test ./...
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>?   	github.com/yyh-gl/go-vcr-sample	<span style=color:#f92672>[</span>no test files<span style=color:#f92672>]</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>ok  	github.com/yyh-gl/go-vcr-sample/qiita	0.472s
</code></pre></div><p>普通にテストが通りますね。</p><p>では、この状態で、ネットワーク（WiFi）を切って、再度テストしてみます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>$ go test ./...
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>?   	github.com/yyh-gl/go-vcr-sample	<span style=color:#f92672>[</span>no test files<span style=color:#f92672>]</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>ok  	github.com/yyh-gl/go-vcr-sample/qiita	0.014s
</code></pre></div><p>成功しました。<br>&ldquo;保存された通信内容"を見ているので、ネットワークに繋がっていなくても、テストが通ります。<br>（&ldquo;保存された通信内容"がどこにあるかは後で説明します）<br>つまり、<u>モック化できてしまっているのです！</u></p><p>しかも、実行時間が短くなっていますね！これはでかい。</p><p>では、&ldquo;保存された通信内容"を消して、再度テストしてみましょう。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>$ go test ./...
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>?   	github.com/yyh-gl/go-vcr-sample	<span style=color:#f92672>[</span>no test files<span style=color:#f92672>]</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>panic: runtime error: invalid memory address or nil pointer dereference <span style=color:#f92672>[</span>recovered<span style=color:#f92672>]</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>	panic: runtime error: invalid memory address or nil pointer dereference
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>[</span>signal SIGSEGV: segmentation violation code<span style=color:#f92672>=</span>0x1 addr<span style=color:#f92672>=</span>0x40 pc<span style=color:#f92672>=</span>0x12aef8d<span style=color:#f92672>]</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>goroutine <span style=color:#ae81ff>21</span> <span style=color:#f92672>[</span>running<span style=color:#f92672>]</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>testing.tRunner.func1<span style=color:#f92672>(</span>0xc0000fe200<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	/Users/yyh-gl/.anyenv/envs/goenv/versions/1.13.4/src/testing/testing.go:874 +0x3a3
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>panic<span style=color:#f92672>(</span>0x1343900, 0x1642f80<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>	/Users/yyh-gl/.anyenv/envs/goenv/versions/1.13.4/src/runtime/panic.go:679 +0x1b2
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>github.com/yyh-gl/go-vcr-sample/qiita.Client.FetchUser<span style=color:#f92672>(</span>0xc00008b2c0, 0x13a96ac, 0x6, 0x104fe28<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	/Users/yyh-gl/workspaces/Go/src/github.com/yyh-gl/go-vcr-sample/qiita/qiita.go:26 +0x10d
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>github.com/yyh-gl/go-vcr-sample/qiita_test.Test_FetchUser.func1<span style=color:#f92672>(</span>0xc0000fe200<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>	/Users/yyh-gl/workspaces/Go/src/github.com/yyh-gl/go-vcr-sample/qiita/qiita_test.go:37 +0x49
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>testing.tRunner<span style=color:#f92672>(</span>0xc0000fe200, 0xc0000a0540<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>	/Users/yyh-gl/.anyenv/envs/goenv/versions/1.13.4/src/testing/testing.go:909 +0xc9
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>created by testing.<span style=color:#f92672>(</span>*T<span style=color:#f92672>)</span>.Run
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>	/Users/yyh-gl/.anyenv/envs/goenv/versions/1.13.4/src/testing/testing.go:960 +0x350
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>FAIL	github.com/yyh-gl/go-vcr-sample/qiita	0.020s
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>FAIL
</code></pre></div><p>エラーになりましたね。<br>ちゃんとエラーハンドリングしていないので、nil参照のエラーになっていますが、<br>これはネットワークに繋がっていない（＋"保存された通信内容"がない）ために、<br>外部APIへのリクエストが失敗し、発生したエラーです。</p><br><hr><h1 id=保存された通信内容>&ldquo;保存された通信内容&rdquo;</h1><hr><p>では、さきほど go test を初めて実行したときに何が起こっていたのかを説明します。</p><p>プロジェクト内を見てみると、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>$ tree go-vcr-sample
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>go-vcr-sample
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>├── fixtures
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>│   └── qiita.yaml
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>├── go.mod
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>├── go.sum
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>├── main.go
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>└── qiita
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>    ├── qiita.go
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>    └── qiita_test.go
</code></pre></div><p><code>fixtures</code> ディレクトリができています。</p><p>中身を見てみると、</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>$ ls fixtures
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>qiita.yaml
</code></pre></div><p><code>qiita.yaml</code> ができています。<br></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e># /fixtures/qiita.yaml</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>---
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>interactions</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>- <span style=color:#f92672>request</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>    <span style=color:#f92672>body</span>: <span style=color:#e6db74>&#34;&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>    <span style=color:#f92672>form</span>: {}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>    <span style=color:#f92672>headers</span>: {}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://qiita.com/api/v2/users/yyh-gl</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>    <span style=color:#f92672>method</span>: <span style=color:#ae81ff>GET</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>  <span style=color:#f92672>response</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>    <span style=color:#f92672>body</span>: <span style=color:#e6db74>&#34;{\&#34;description\&#34;:\&#34;東京でエンジニアしてます／CLI名刺 $ npx yyh-gl／メインは個人ブログです\U0001F4DD\&#34;,\&#34;facebook_id\&#34;:\&#34;\&#34;,\&#34;followees_count\&#34;:19,\&#34;followers_count\&#34;:18,\&#34;github_login_name\&#34;:\&#34;yyh-gl\&#34;,\&#34;id\&#34;:\&#34;yyh-gl\&#34;,\&#34;items_count\&#34;:11,\&#34;linkedin_id\&#34;:\&#34;\&#34;,\&#34;location\&#34;:\&#34;Tokyo,
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#e6db74>      Japan\&#34;,\&#34;name\&#34;:\&#34;\&#34;,\&#34;organization\&#34;:\&#34;\&#34;,\&#34;permanent_id\&#34;:119088,\&#34;profile_image_url\&#34;:\&#34;https://qiita-image-store.s3.amazonaws.com/0/119088/profile-images/1535528464\&#34;,\&#34;team_only\&#34;:false,\&#34;twitter_screen_name\&#34;:null,\&#34;website_url\&#34;:\&#34;https://yyh-gl.github.io/tech-blog/\&#34;}&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>    <span style=color:#f92672>headers</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>      <span style=color:#f92672>Cache-Control</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>      - <span style=color:#ae81ff>max-age=0, private, must-revalidate</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>      <span style=color:#f92672>Content-Type</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>      - <span style=color:#ae81ff>application/json; charset=utf-8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>      <span style=color:#f92672>Date</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>      - <span style=color:#ae81ff>Sat, 07 Dec 2019 07:27:05 GMT</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>      <span style=color:#f92672>Etag</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>      - <span style=color:#ae81ff>W/&#34;a6adaa36bf27d2045a25659539dcdae5&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>      <span style=color:#f92672>Rate-Limit</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>      - <span style=color:#e6db74>&#34;60&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>      <span style=color:#f92672>Rate-Remaining</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>      - <span style=color:#e6db74>&#34;56&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>      <span style=color:#f92672>Rate-Reset</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>      - <span style=color:#e6db74>&#34;1575706459&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>      <span style=color:#f92672>Referrer-Policy</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>      - <span style=color:#ae81ff>strict-origin-when-cross-origin</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span>      <span style=color:#f92672>Server</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span>      - <span style=color:#ae81ff>nginx</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>      <span style=color:#f92672>Strict-Transport-Security</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span>      - <span style=color:#ae81ff>max-age=2592000</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span>      <span style=color:#f92672>Vary</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span>      - <span style=color:#ae81ff>Origin</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span>      <span style=color:#f92672>X-Content-Type-Options</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span>      - <span style=color:#ae81ff>nosniff</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span>      <span style=color:#f92672>X-Download-Options</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span>      - <span style=color:#ae81ff>noopen</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span>      <span style=color:#f92672>X-Frame-Options</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span>      - <span style=color:#ae81ff>SAMEORIGIN</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span>      <span style=color:#f92672>X-Permitted-Cross-Domain-Policies</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span>      - <span style=color:#ae81ff>none</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span>      <span style=color:#f92672>X-Request-Id</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span>      - <span style=color:#ae81ff>f0ca74f0-4aae-4d0f-b6f9-ec08b0407b56</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span>      <span style=color:#f92672>X-Runtime</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span>      - <span style=color:#e6db74>&#34;0.082646&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span>      <span style=color:#f92672>X-Xss-Protection</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span>      - <span style=color:#ae81ff>1</span><span style=color:#ae81ff>; mode=block</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span>    <span style=color:#f92672>status</span>: <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>OK</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span>    <span style=color:#f92672>code</span>: <span style=color:#ae81ff>200</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span>    <span style=color:#f92672>duration</span>: <span style=color:#e6db74>&#34;&#34;</span>
</code></pre></div><p>リクエストおよびレスポンスの内容が全て保存されています。</p><br><p>このように、go-vcr では、通信内容を傍受して、yaml 形式で保存します。<br>（内容自体も、Web エンジニアならよく見かける単語ばかりなので読みやすいですね）</p><p>そして、この yaml ファイルがあるときは、外部APIに対してリクエストを飛ばさずに、<br>yaml ファイルの内容からレスポンスを返します。</p><br><hr><h1 id=リクエスト済みかどうかの判断方法>リクエスト済みかどうかの判断方法</h1><hr><p>ここで、go-vcr がどのようにして、<br>リクエストを送ったことがあるかどうかを判定しているのか説明していきます。</p><p>答えは<a href=https://github.com/dnaeon/go-vcr/blob/9384691f0462689770c3e930cd8aff05c7075a5b/cassette/cassette.go#L103-L107>こちら</a>のコードにあります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#75715e>// DefaultMatcher is used when a custom matcher is not defined
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#75715e>// and compares only the method and URL.
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DefaultMatcher</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>i</span> <span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>bool</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Method</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>Method</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>String</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>URL</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span>}
</code></pre></div><blockquote><p>compares only the method and URL.</p></blockquote><p>デフォルトだと、HTTP メソッドとリクエストURL しか見てないんですね。</p><p>しかし、この判定処理において、<br>HTTP メソッドとリクエストURL以外も見るようにしたかったり、<br>逆にこのURLへのリクエストだけは保存したくないといったニーズもあると思います。<br>そこで 登場するのが <u>Custom Request Matching</u> です。</p><br><h2 id=custom-request-matching>Custom Request Matching</h2><p><a href=https://github.com/dnaeon/go-vcr#custom-request-matching>README.md</a> にもあるとおり、<br>Matcher を作ってあげるだけで、簡単にオリジナルの判定処理を実装可能です。</p><p>さきほどの README.md にあるサンプルを拝借して、<br>僕のコード書き換えてみると以下のとおりになります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e>// /qiita/qiita_test.go
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#75715e></span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>package</span> <span style=color:#a6e22e>qiita_test</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#f92672>import</span> (
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#e6db74>&#34;bytes&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	<span style=color:#e6db74>&#34;testing&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>	<span style=color:#e6db74>&#34;github.com/dnaeon/go-vcr/cassette&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#e6db74>&#34;github.com/dnaeon/go-vcr/recorder&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>	<span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>	<span style=color:#e6db74>&#34;github.com/yyh-gl/go-vcr-sample/qiita&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_FetchUser</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>	<span style=color:#a6e22e>tests</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>		<span style=color:#a6e22e>testCase</span>     <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>		<span style=color:#a6e22e>id</span>           <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>		<span style=color:#a6e22e>wantLocation</span> <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>	}{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>		{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>			<span style=color:#a6e22e>testCase</span>:     <span style=color:#e6db74>&#34;Qiitaからyyh-glのユーザ情報を取得できていること&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>			<span style=color:#a6e22e>id</span>:           <span style=color:#e6db74>&#34;yyh-gl&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>			<span style=color:#a6e22e>wantLocation</span>: <span style=color:#e6db74>&#34;Tokyo, Japan&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>		},
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>	<span style=color:#75715e>// go-vcr のレコーダを生成
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span style=color:#75715e></span>	<span style=color:#75715e>// 通信内容は ../fixtures/qiita に保存される
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>recorder</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;../fixtures/qiita&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Stop</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span>    <span style=color:#75715e>// ここ
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>SetMatcher</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>i</span> <span style=color:#a6e22e>cassette</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>bool</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cassette</span>.<span style=color:#a6e22e>DefaultMatcher</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>i</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span>		}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ReadFrom</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span>		}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span>		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>NopCloser</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>b</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cassette</span>.<span style=color:#a6e22e>DefaultMatcher</span>(<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>i</span>) <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>String</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>String</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>Body</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span>	})
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span>	<span style=color:#a6e22e>customHTTPClient</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span>		<span style=color:#a6e22e>Transport</span>: <span style=color:#a6e22e>r</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span>	<span style=color:#a6e22e>qiitaClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiita</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>customHTTPClient</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tt</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tests</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>testCase</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span>			<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>qiitaClient</span>.<span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>id</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span>			<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>tt</span>.<span style=color:#a6e22e>wantLocation</span>, <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Location</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span>		})
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span>}
</code></pre></div><p><code>SetMatcher()</code> 内の処理によって、判定ロジックを変更します。<br>この例だと、HTTP メソッドとリクエストURL に加えて、リクエストBody の内容も見るようになっています。</p><p>このように、<code>SetMatcher()</code> を定義してやるだけです。<br>後はいつもどおり、http.Client の Transport に渡してやるだけなので簡単ですね👍</p><br><hr><h1 id=保存内容を修正する必要が出たときはどうする>保存内容を修正する必要が出たときはどうする？</h1><hr><p>yaml ファイルを消すだけです。</p><p>例えば、外部APIの仕様が変わり、モックを更新する必要が出てきた場合は、<br>yaml ファイルを消してやるだけで、次のAPIリクエストの内容を保存 => つまり、モックを更新できます。</p><p>もちろん yaml ファイルを直接変更することもできます。</p><p>モックの管理が楽になりますね👍</p><br><hr><h1 id=まとめ>まとめ</h1><hr><p>go-vcr を利用することで、外部API通信のモック化および管理が簡単にできるようになりました。<br>しかも、モックの内容は、実際にリクエストして得た内容なので、<br>仕様が漏れることもないでしょう。</p><p>また、今回は説明しませんでしたが、<br>go-vcr には <a href=https://github.com/dnaeon/go-vcr#protecting-sensitive-data>Protecting Sensitive Data</a> という機能もあり、<br>指定したデータを保存しないようにするといったこともできます。</p><p>カスタマイズ性が高く、とてもおすすめのライブラリです。</p><p>もしモックの作成・管理で悩んでいる方がおられたら、<br>ぜひ一度検討してみてください！</p><br><p>Go3 Advent Calendar 2019、明日は <a href=https://qiita.com/EbiEbiEvidence>EbiEbiEvidence</a> さんです🛫</p></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/tech-blog/categories/go/>Go</a></li><li><a class=article-terms-link href=/tech-blog/categories/%e3%83%86%e3%82%b9%e3%83%88/>テスト</a></li><li><a class=article-terms-link href=/tech-blog/categories/advent-calendar/>Advent Calendar</a></li></ul><div><good-counter url=/tech-blog/blog/golang-vcr/></good-counter></div></div></footer></article><div class=pagination><a href=/tech-blog/blog/golangci-lint-custom-settings/ class="button left"><span>GolangCI-Lintの設定ファイルを理解する</span></a>
<a href=/tech-blog/blog/react_typescript_sample/ class="button right"><span>【React+TypeScript】TypeScript入門</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>最近の投稿</h1></header><article class=mini-post><a href=/tech-blog/blog/go-switch-fallthrough/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/go-switch-fallthrough/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/go-switch-fallthrough/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/go-switch-fallthrough/>【Go】Switch文のfallthroughに関するまとめ</a></h2><time class=published datetime="2020-10-03 00:00:00 +0000 UTC">2020-10-03</time></header></article><article class=mini-post><a href=/tech-blog/blog/podcast-matome-texta-200827/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/podcast-matome-texta-200827/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/podcast-matome-texta-200827/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/podcast-matome-texta-200827/>texta.fm #1 まとめ</a></h2><time class=published datetime="2020-10-01 00:00:00 +0000 UTC">2020-10-01</time></header></article><article class=mini-post><a href=/tech-blog/blog/go-always-passing-by-value/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/06/go-always-passing-by-value/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/06/go-always-passing-by-value/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/go-always-passing-by-value/>Goの参照渡しについて調べてみた</a></h2><time class=published datetime="2020-06-14 00:00:00 +0000 UTC">2020-06-14</time></header></article><footer><a href=/tech-blog/blog/ class=button>続きを見る</a></footer></section><section id=categories><header><h1><a href=/tech-blog/categories>Categories</a></h1></header><ul><li><a href=/tech-blog/categories/go/>go<span class=count>17</span></a><li><a href=/tech-blog/categories/%E5%8B%89%E5%BC%B7%E4%BC%9A/>勉強会<span class=count>6</span></a><li><a href=/tech-blog/categories/ddd/>ddd<span class=count>5</span></a><li><a href=/tech-blog/categories/advent-calendar/>advent-calendar<span class=count>3</span></a><li><a href=/tech-blog/categories/web-api/>web-api<span class=count>3</span></a><li><a href=/tech-blog/categories/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/>アーキテクチャ<span class=count>3</span></a><li><a href=/tech-blog/categories/%E8%AA%AD%E6%9B%B8%E3%81%BE%E3%81%A8%E3%82%81/>読書まとめ<span class=count>3</span></a><li><a href=/tech-blog/categories/html/css/>html/css<span class=count>2</span></a><li><a href=/tech-blog/categories/react/>react<span class=count>2</span></a><li><a href=/tech-blog/categories/web%E5%85%A8%E8%88%AC/>web全般<span class=count>2</span></a><li><a href=/tech-blog/categories/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3/>セキュリティ<span class=count>2</span></a><li><a href=/tech-blog/categories/%E3%83%86%E3%82%B9%E3%83%88/>テスト<span class=count>2</span></a><li><a href=/tech-blog/categories/android/>android<span class=count>1</span></a><li><a href=/tech-blog/categories/aws/>aws<span class=count>1</span></a><li><a href=/tech-blog/categories/ci/cd/>ci/cd<span class=count>1</span></a><li><a href=/tech-blog/categories/ecs/>ecs<span class=count>1</span></a><li><a href=/tech-blog/categories/firebase/>firebase<span class=count>1</span></a><li><a href=/tech-blog/categories/github/>github<span class=count>1</span></a><li><a href=/tech-blog/categories/kotlin/>kotlin<span class=count>1</span></a><li><a href=/tech-blog/categories/lint/>lint<span class=count>1</span></a><li><a href=/tech-blog/categories/podcast/>podcast<span class=count>1</span></a><li><a href=/tech-blog/categories/rds/>rds<span class=count>1</span></a><li><a href=/tech-blog/categories/terraform/>terraform<span class=count>1</span></a><li><a href=/tech-blog/categories/typescript/>typescript<span class=count>1</span></a><li><a href=/tech-blog/categories/vue.js/>vue.js<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%82%B9%E3%82%AF%E3%83%A9%E3%83%A0/>スクラム<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%83%81%E3%83%BC%E3%83%A0%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88/>チームマネジメント<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%83%9D%E3%82%A8%E3%83%A0/>ポエム<span class=count>1</span></a><li><a href=/tech-blog/categories/%E5%85%A5%E9%96%80/>入門<span class=count>1</span></a><li><a href=/tech-blog/categories/%E7%B0%A1%E5%8D%98%E3%81%BE%E3%81%A8%E3%82%81/>簡単まとめ<span class=count>1</span></a><li><a href=/tech-blog/categories/%E8%87%AA%E5%B7%B1%E7%B4%B9%E4%BB%8B/>自己紹介<span class=count>1</span></a></li></ul></section><section id=mini-bio><header><h1>About</h1></header><p>東京で働くソフトウェアエンジニアです。バックエンドがメインですが、フロントやインフラもさわっています。</p><footer><a href=/tech-blog/about class=button>もっと詳しく知る</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul><p class=copyright>© 2020 yyh-gl's Tech Blog<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.77.0 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/tech-blog/js/bundle.min.11dc02371cad2fde919e03b0002d46d9cd2420aeab5f006e3f3ae9662ba228f8.js integrity="sha256-EdwCNxytL96RngOwAC1G2c0kIK6rXwBuPzrpZiuiKPg="></script><script src=/tech-blog/js/add-on.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-140914324-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>