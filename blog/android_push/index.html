<!doctype html><html lang=ja><head><meta charset=utf-8><title>【Android + Kotlin + Firebase】Androidアプリにプッシュ通知を実装してみた - yyh-gl's Tech Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/tech-blog/favicon/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/tech-blog/favicon/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/tech-blog/favicon/favicon-16x16.png?v=1"><link rel=manifest href="/tech-blog/favicon/site.webmanifest?v=1"><link rel=mask-icon href="/tech-blog/favicon/safari-pinned-tab.svg?v=1" color=#ffffff><link rel="shortcut icon" href="/tech-blog/favicon/favicon.ico?v=1"><meta name=msapplication-config content="/tech-blog/favicon/browserconfig.xml?v=1"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.77.0"><meta property="og:site_name" content="yyh-gl's Tech Blog"><meta property="og:title" content="【Android + Kotlin + Firebase】Androidアプリにプッシュ通知を実装してみた"><meta property="og:description" content="技術系ネタ中心のブログです。サーバサイドをメインとしたフルスタックエンジニアを目指しています。"><meta property="description" content="技術系ネタ中心のブログです。サーバサイドをメインとしたフルスタックエンジニアを目指しています。"><meta property="og:url" content="https://yyh-gl.github.io/tech-blog/blog/android_push/"><meta property="og:type" content="article"><meta property="og:image" content="https://yyh-gl.github.io/tech-blog/img/main/logo.png"><link rel=stylesheet href=/tech-blog/css/bundle.min.e4a0b0705b8f8ce6273c21134a9e69bb89bd526da868b7e33bfa5fb249ba0c2b.css integrity="sha256-5KCwcFuPjOYnPCETSp5pu4m9Um2oaLfjO/pfskm6DCs="><link rel=stylesheet href=/tech-blog/css/add-on.css><script src=https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js></script><script src=/tech-blog/js/vue.min.js></script><script src=/tech-blog/js/good-counter.js defer></script></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/tech-blog/ class=nav>Blog</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/tech-blog/ class="nav link"><i class="fa fa-home"></i>Home</a>
<a href=/tech-blog/about/ class="nav link"><i class="far fa-id-card"></i>About</a>
<a href=/tech-blog/blog/ class="nav link"><i class="far fa-newspaper"></i>Blog</a>
<a href=/tech-blog/categories/ class="nav link"><i class="fas fa-sitemap"></i>Categories</a></menu>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav></header><div id=wrapper><section id=site-intro><a href=/tech-blog/><img src=https://yyh-gl.github.io/tech-blog/img/main/logo.png class=circle width=80 alt="yyh-gl's icon"></a><header><h1>yyh-gl's Tech Blog</h1></header><main><p>技術ネタ中心のブログです。主な扱いはバックエンド技術と設計です。</p></main><footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/tech-blog/blog/android_push/>【Android + Kotlin + Firebase】Androidアプリにプッシュ通知を実装してみた</a></h2></div><div class=meta><time datetime="2019-05-30 00:00:00 +0000 UTC">2019-05-30</time><p>yyh-gl</p><p>3 分で読めます</p></div></header><div id=socnet-share></div><div class=content><a href=/tech-blog/blog/android_push/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/featured.png alt=画像がどこかへ逝ってしまったようだ…></a><br><p>僕がひっかかった場所は 「つまづきポイント」 という章にまとめているので</p><p>なにか困ったときはそこを一度見てみてください。</p><hr><h1 id=tldr>tl;dr</h1><hr><ul><li>Firebase使ってAndroidアプリにプッシュ通知を実装した</li><li>フォアグラウンドとバックグラウンドで表示方法が異なる</li><li>めちゃくちゃ簡単</li></ul><hr><h1 id=開発環境>開発環境</h1><hr><ul><li>macOS Mojave 10.14.4</li><li>Android Studio 3.4.1</li><li>Gradle 3.4.1</li><li>Java 1.8.0_202</li><li>Kotlin 1.3.21</li></ul><hr><h1 id=firebaseに登録>Firebaseに登録</h1><hr><p>Firebaseを使用するためには登録が必要です。</p><p>Googleアカウントを持っている方なら<a href="https://firebase.google.com/?hl=ja">公式サイト</a>から簡単に登録できます</p><hr><h1 id=firebaseにプロジェクト作成>Firebaseにプロジェクト作成</h1><hr><p><a href=https://console.firebase.google.com/>プロジェクト登録ページ</a>でプロジェクトを登録します。</p><p>プロジェクト名は特に指定はありません。ご自由にどうぞ。</p><hr><h1 id=アプリ情報を登録する>アプリ情報を登録する</h1><hr><p>プロジェクト選択後のホーム画面より 「Project Overview」 をクリック。</p><p>画面の指示に従って進めていてください。</p><br><h2 id=デバッグ用の署名証明書-sha-1-の取得方法>デバッグ用の署名証明書 SHA-1 の取得方法</h2><ol><li><p>以下コマンドを実行</p><p>Mac/Linux</p><pre><code>keytool -list -v \
-alias androiddebugkey -keystore ~/.android/debug.keystore
</code></pre><p>Windows</p><pre><code>keytool -list -v \
-alias androiddebugkey -keystore %USERPROFILE%\.android\debug.keystore
</code></pre></li><li><p>パスワード入力</p><p>パスワードは <code>android</code> です。</p></li><li><p>表示される SHA-1 をメモ</p></li></ol><br><hr><p>ひととおり作業が進むと、↓このような画面が表示されます。</p><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/app-registering-complete.png width=750><p>自分の環境では、登録したアプリがFirebaseと通信できているかのチェックに少し時間がかかりました。</p><p>エミュレータでもちゃんと通信してくれるか不安だったのですが大丈夫でした。</p><hr><h1 id=firebase-関連のライブラリを追加>Firebase 関連のライブラリを追加</h1><hr><p>アプリ情報の登録工程において、 <code>app/build.gradle</code> を触ったと思いますが、加えて、以下の追記が必要です。</p><pre><code>dependencies {
    // ... 省略

    implementation 'com.google.firebase:firebase-messaging:18.0.0'
}
</code></pre><p>バージョン17.1.0 以降に関して、 <a href=https://qiita.com/taki4227/items/9d292c3badd2c4015061>こちらの記事</a>にあるとおり、大きな変更が加わっています。</p><p>注意しましょう。</p><hr><h1 id=通知時の見た目の設定バックグラウンド動作時>通知時の見た目の設定（バックグラウンド動作時）</h1><hr><p><u>PUSH通知の見た目はバックグラウンドとフォアグラウンドで違います。</u></p><p>フォアグラウンドでのPUSH通知は自分のアプリの処理を通りますが、</p><p>バックグラウンドではアプリで定義した処理を通りません。</p><br><p>まずはバックグラウンドの見た目を設定していきます。</p><p><code>AndroidManifest.xml</code> に下記のとおり追記してください。</p><pre><code>&lt;application
    // ... 省略

&gt;

    // ... 省略

    &lt;meta-data
      android:name=&quot;com.google.firebase.messaging.default_notification_channel_id&quot;
      android:value=&quot;@string/channel_id&quot;/&gt;

    &lt;meta-data
      android:name=&quot;com.google.firebase.messaging.default_notification_icon&quot;
      android:resource=&quot;@drawable/ic_logo&quot; /&gt;

    &lt;meta-data
      android:name=&quot;com.google.firebase.messaging.default_notification_color&quot;
      android:resource=&quot;@color/background&quot; /&gt;
      
    // ... 省略
</code></pre><p>ここでチャンネルIDと通知アイコン、色を決定します。</p><p>各自で自由に設定してください。</p><blockquote><p>チャンネルID は Android 8.0（API レベル 26）以降で設定が必須となりました。</p></blockquote><blockquote><p>チャンネルを指定することで、ユーザーが任意の通知チャンネルを無効にすることが可能になります。</p></blockquote><blockquote><p><a href=https://developer.android.com/guide/topics/ui/notifiers/notifications#ManageChannels>参考サイト</a></p></blockquote><blockquote><p>★ Android 8.0 未満であれば気にしなくて大丈夫です。</p></blockquote><hr><h1 id=動作テスト>動作テスト</h1><hr><p>以上でバックグラウンドでの通知は受け取れるようになりました。</p><p>Cloud Messaging 画面に行き、「Send your first message」から通知を作成します。</p><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/send_notification.png width=750><br><ol><li><p>通知のタイトルとメッセージを設定します。</p><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/create_message.png width=750></li><li><p>ターゲットは自分のアプリを選択してください。</p></li><li><p>スケジュールは <code>Now</code> です。</p></li><li><p>今回はコンバージョンイベントはなにも触りません。</p></li><li><p>その他のオプションはチャンネルIDだけ設定します（Android8.0以上の人のみ）</p><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/other_option.png width=750></li><li><p>「確認」 > 「公開」 で通知が送られます。</p></li></ol><p>Android側で通知を受け取れているか確認しましょう。</p><p>注意としては、現状バックグラウンドでの処理しか記述していないので</p><p>アプリを開いていると通知を受け取れません。</p><p>アプリを閉じた状態で通知を送りましょう。</p><p>すると…</p><p>通知が来ましたね！ 音もついています。</p><div style=display:inline-block><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/top.png width=250><pre><code>&lt;img src=&quot;https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/bar.png&quot; width=&quot;250&quot;&gt;

&lt;img src=&quot;https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/notification_center.png&quot; width=&quot;250&quot;&gt;
</code></pre></div><p>ステータスバーにもアイコンが表示されています（鳥のマークです）。</p><p>でも、アプリ立ち上げた状態（フォアグラウンド）だと通知来ないですよね？</p><p>表示できるようにしていきましょう。</p><hr><h1 id=通知時の見た目の設定フォアグラウンド動作時>通知時の見た目の設定（フォアグラウンド動作時）</h1><hr><p>各自の適当な場所に以下の Service を作成してください。</p><blockquote><p>下記コードについて、Kotlinのシンタックスハイライトに対応しておらず、</p></blockquote><blockquote><p>Javaのシンタックスハイライトで代用しています。</p></blockquote><blockquote><p>もしおかしなハイライトがあればごめんなさいします。</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span style=color:#f92672>package</span> <span style=color:#960050;background-color:#1e0010>&lt;</span>パッケージ名<span style=color:#f92672>&gt;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span style=color:#f92672>import</span> android.app.Notification
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span style=color:#f92672>import</span> android.app.NotificationChannel
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span style=color:#f92672>import</span> android.app.NotificationManager
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span style=color:#f92672>import</span> android.app.PendingIntent
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span style=color:#f92672>import</span> android.content.Context
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span style=color:#f92672>import</span> android.content.Intent
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span style=color:#f92672>import</span> android.media.RingtoneManager
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span style=color:#f92672>import</span> android.os.Build
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span style=color:#f92672>import</span> androidx.core.app.NotificationCompat
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span style=color:#f92672>import</span> androidx.core.app.NotificationCompat.PRIORITY_MAX
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span style=color:#f92672>import</span> com.google.firebase.messaging.FirebaseMessagingService
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span style=color:#f92672>import</span> com.google.firebase.messaging.RemoteMessage
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span style=color:#f92672>import</span> java.util.*
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PushNotificationListenerService</span><span style=color:#f92672>:</span> FirebaseMessagingService<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span>  <span style=color:#75715e>// 新しいトークンが生成された時の処理
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span style=color:#75715e></span>  <span style=color:#75715e>// 中でサーバにトークンを送信する処理などを定義
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span style=color:#75715e></span>  override fun <span style=color:#a6e22e>onNewToken</span><span style=color:#f92672>(</span>p0<span style=color:#f92672>:</span> String<span style=color:#f92672>?)</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onNewToken</span><span style=color:#f92672>(</span>p0<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span>    <span style=color:#75715e>// チャンネルidを設定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span style=color:#75715e></span>    addChannelId<span style=color:#f92672>()</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span>  <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span>  <span style=color:#75715e>// 通知を受信したときの処理
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span style=color:#75715e></span>  override fun <span style=color:#a6e22e>onMessageReceived</span><span style=color:#f92672>(</span>message<span style=color:#f92672>:</span> RemoteMessage<span style=color:#f92672>?)</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onMessageReceived</span><span style=color:#f92672>(</span>message<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span>    <span style=color:#75715e>// 今回は通知からタイトルと本文を取得
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span style=color:#75715e></span>    val title<span style=color:#f92672>:</span> String <span style=color:#f92672>=</span> message<span style=color:#f92672>?.</span><span style=color:#a6e22e>notification</span><span style=color:#f92672>?.</span><span style=color:#a6e22e>title</span><span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span>    val text<span style=color:#f92672>:</span> String <span style=color:#f92672>=</span> message<span style=color:#f92672>?.</span><span style=color:#a6e22e>notification</span><span style=color:#f92672>?.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span>    <span style=color:#75715e>// 通知表示
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span style=color:#75715e></span>    sendNotification<span style=color:#f92672>(</span>title<span style=color:#f92672>,</span> text<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span>  <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span>  <span style=color:#75715e>// 通知表示 および 見た目の設定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> fun <span style=color:#a6e22e>sendNotification</span><span style=color:#f92672>(</span>title<span style=color:#f92672>:</span> String<span style=color:#f92672>,</span> text<span style=color:#f92672>:</span> String<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span>    <span style=color:#75715e>// 通知タップ時に遷移するアクティビティを指定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span style=color:#75715e></span>    val intent <span style=color:#f92672>=</span> Intent<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> AllTimelineActivity<span style=color:#f92672>::</span>class<span style=color:#f92672>.</span><span style=color:#a6e22e>java</span><span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span>    intent<span style=color:#f92672>.</span><span style=color:#a6e22e>addFlags</span><span style=color:#f92672>(</span>Intent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_ACTIVITY_CLEAR_TOP</span><span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span>    <span style=color:#75715e>// 何度も遷移しないようにする（1度だけ！）
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span style=color:#75715e></span>    val pendingIntent<span style=color:#f92672>:</span> PendingIntent <span style=color:#f92672>=</span> PendingIntent<span style=color:#f92672>.</span><span style=color:#a6e22e>getActivity</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span>0<span style=color:#f92672>,</span> intent<span style=color:#f92672>,</span> PendingIntent<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_ONE_SHOT</span><span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span>    <span style=color:#75715e>// 通知メッセージのスタイルを設定（改行表示に対応）
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span style=color:#75715e></span>    val inboxStyle <span style=color:#f92672>=</span> NotificationCompat<span style=color:#f92672>.</span><span style=color:#a6e22e>InboxStyle</span><span style=color:#f92672>()</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span>    val messageArray<span style=color:#f92672>:</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> text<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>:</span> String in messageArray<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span>      inboxStyle<span style=color:#f92672>.</span><span style=color:#a6e22e>addLine</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span>    <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span>    <span style=color:#75715e>// 通知音の設定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span style=color:#75715e></span>    val defaultSoundUri <span style=color:#f92672>=</span> RingtoneManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultUri</span><span style=color:#f92672>(</span>RingtoneManager<span style=color:#f92672>.</span><span style=color:#a6e22e>TYPE_NOTIFICATION</span><span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span>    <span style=color:#75715e>// 通知の見た目を設定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span style=color:#75715e></span>    val notificationBuilder
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span>      <span style=color:#f92672>=</span> NotificationCompat<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> resources<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>.</span><span style=color:#a6e22e>channel_id</span><span style=color:#f92672>))</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setContentTitle</span><span style=color:#f92672>(</span>title<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setContentText</span><span style=color:#f92672>(</span>text<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span>      <span style=color:#75715e>// ステータスバーに表示されるアイコン
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setSmallIcon</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>drawable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ic_notification_icon</span><span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span>      <span style=color:#75715e>// 上で設定したpendingIntentを設定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setContentIntent</span><span style=color:#f92672>(</span>pendingIntent<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span>      <span style=color:#75715e>// 優先度を最大化
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setPriority</span><span style=color:#f92672>(</span>PRIORITY_MAX<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span>      <span style=color:#75715e>// 通知音を出すように設定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setSound</span><span style=color:#f92672>(</span>defaultSoundUri<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span>    <span style=color:#75715e>// 通知を実施
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span style=color:#75715e></span>    <span style=color:#75715e>// UUIDを付与することで各通知をユニーク化
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span style=color:#75715e></span>    val notificationManager<span style=color:#f92672>:</span> NotificationManager <span style=color:#f92672>=</span> getSystemService<span style=color:#f92672>(</span>Context<span style=color:#f92672>.</span><span style=color:#a6e22e>NOTIFICATION_SERVICE</span><span style=color:#f92672>)</span> as NotificationManager
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span>    val uuid <span style=color:#f92672>=</span> UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span>    notificationManager<span style=color:#f92672>.</span><span style=color:#a6e22e>notify</span><span style=color:#f92672>(</span>uuid<span style=color:#f92672>,</span> notificationBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>())</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span>    <span style=color:#75715e>// Android 8.0 以上はチャンネル設定 必須
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span style=color:#75715e></span>    <span style=color:#75715e>// strings.xml に channel_id を指定してください
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION_CODES</span><span style=color:#f92672>.</span><span style=color:#a6e22e>O</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span>      notificationBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setChannelId</span><span style=color:#f92672>(</span>resources<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>.</span><span style=color:#a6e22e>channel_id</span><span style=color:#f92672>))</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span>    <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span>  <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span>  <span style=color:#75715e>// チャンネルの設定
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> fun <span style=color:#a6e22e>addChannelId</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SDK_INT</span> <span style=color:#f92672>&gt;=</span> Build<span style=color:#f92672>.</span><span style=color:#a6e22e>VERSION_CODES</span><span style=color:#f92672>.</span><span style=color:#a6e22e>O</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span>      val manager <span style=color:#f92672>=</span> getSystemService<span style=color:#f92672>(</span>Context<span style=color:#f92672>.</span><span style=color:#a6e22e>NOTIFICATION_SERVICE</span><span style=color:#f92672>)</span> as NotificationManager
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span>      <span style=color:#75715e>// ヘッドアップ通知を出す場合はチャンネルの重要度を最大にする必要がある
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span style=color:#75715e></span>      val channel <span style=color:#f92672>=</span> NotificationChannel<span style=color:#f92672>(</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span>        resources<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>.</span><span style=color:#a6e22e>channel_id</span><span style=color:#f92672>),</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span>        resources<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>.</span><span style=color:#a6e22e>channel_name</span><span style=color:#f92672>),</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span>        NotificationManager<span style=color:#f92672>.</span><span style=color:#a6e22e>IMPORTANCE_HIGH</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span>      <span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span>      <span style=color:#75715e>// ロック画面における表示レベル
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span style=color:#75715e></span>      channel<span style=color:#f92672>.</span><span style=color:#a6e22e>lockscreenVisibility</span> <span style=color:#f92672>=</span> Notification<span style=color:#f92672>.</span><span style=color:#a6e22e>VISIBILITY_PUBLIC</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span>      <span style=color:#75715e>// チャンネル登録
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span style=color:#75715e></span>      manager<span style=color:#f92672>.</span><span style=color:#a6e22e>createNotificationChannel</span><span style=color:#f92672>(</span>channel<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span>    <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span>  <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span style=color:#f92672>}</span>
</code></pre></div><p>上記コードは <a href=https://www.villness.com/2363>本サイト</a> を参考にしました。</p><p>古いバージョンの情報部分を書き換えたりしています。</p><hr><h1 id=androidmanifest-を修正>AndroidManifest を修正</h1><hr><p>↑で実装した Service をマニフェストに登録し、使えるようにします。</p><p><code>AndroidManifest.xml</code> に以下の設定を追記します。</p><pre><code>&lt;application
    // ... 省略
    &gt;

    &lt;service
      android:name=&quot;.PushNotificationListenerService&quot;&gt;
      &lt;intent-filter&gt;
        &lt;action android:name=&quot;com.google.firebase.MESSAGING_EVENT&quot; /&gt;
      &lt;/intent-filter&gt;
    &lt;/service&gt;
    
    // ... 省略
&lt;/application&gt;
</code></pre><p><code>android:name</code> は各自のディレクトリ構成とファイル名に合わせて変更してください。</p><hr><h1 id=動作テスト-1>動作テスト</h1><hr><p>以上でフォアグラウンドにおける通知の設定が完了しました。</p><p>通知を受け取れるかテストしてみましょう。</p><p>バックグラウンドでのテストと同様の手順で Cloud Messaging から通知を送ります。</p><p>すると…</p><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2019/05/android_push/foreground.png width=280><p>無事表示できましたね！</p><p>ステータスバーにもアイコンが出ています。</p><blockquote><p>アプリ画面は見せれないので隠しています</p></blockquote><blockquote><p>ちょっとフォアグラウンドなのか分かりづらいと思いますが、 <u>フォアグラウンドです</u>。</p></blockquote><hr><h1 id=つまづきポイント>つまづきポイント</h1><hr><p>バックグラウンドとフォアグラウンドどちらにおいても、通知がうまく表示されないときがありました。</p><p>具体的には</p><ol><li>そもそも通知がこない</li><li>フォアグラウンドにて画面上部から通知がぴこって出てこない</li></ol><p>などです。</p><p>原因ですが、僕の結論は <u>エミュレータでテストしていたこと</u> です。</p><p>エミュレータで通知を受け取れない状況において、実機でも通知を受け取ってみたところ、</p><p>実機では正常に通知を受け取ることができました。</p><p>みなさんもエミュレータでテストするさいはお気をつけください。</p><p>（それにしてもなんで無理だったんだろうか… また調べてみよう）</p><hr><h1 id=まとめ>まとめ</h1><hr><p>PUSH通知実装いかかがだったでしょうか？</p><p>僕的にはとても簡単で驚きしかありませんでした。</p><p>Firebaseさまさまですね。</p><p>実際の業務に使えるかと言われると、また話が違ってくるのかもしれませんが、、、</p><hr><h1 id=参考サイト>参考サイト</h1><hr><ul><li><p><a href=https://www.villness.com/2363>https://www.villness.com/2363</a></p></li><li><p><a href="https://firebase.google.com/docs/cloud-messaging?hl=ja">https://firebase.google.com/docs/cloud-messaging?hl=ja</a></p></li></ul></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/tech-blog/categories/android/>Android</a></li><li><a class=article-terms-link href=/tech-blog/categories/kotlin/>Kotlin</a></li><li><a class=article-terms-link href=/tech-blog/categories/firebase/>Firebase</a></li></ul><div><good-counter url=/tech-blog/blog/android_push/></good-counter></div></div></footer></article><div class=pagination><a href=/tech-blog/blog/terraform_ecs/ class="button left"><span>【Terraform + ECS + RDS】Terraform で ECS環境構築してみた</span></a>
<a href=/tech-blog/blog/engineering_organization_theory_mentoring/ class="button right"><span>【エンジニアリング組織論への招待】メンタリングの技術</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>最近の投稿</h1></header><article class=mini-post><a href=/tech-blog/blog/go-switch-fallthrough/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/go-switch-fallthrough/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/go-switch-fallthrough/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/go-switch-fallthrough/>【Go】Switch文のfallthroughに関するまとめ</a></h2><time class=published datetime="2020-10-03 00:00:00 +0000 UTC">2020-10-03</time></header></article><article class=mini-post><a href=/tech-blog/blog/podcast-matome-texta-200827/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/podcast-matome-texta-200827/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/podcast-matome-texta-200827/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/podcast-matome-texta-200827/>texta.fm #1 まとめ</a></h2><time class=published datetime="2020-10-01 00:00:00 +0000 UTC">2020-10-01</time></header></article><article class=mini-post><a href=/tech-blog/blog/go-always-passing-by-value/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/06/go-always-passing-by-value/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/06/go-always-passing-by-value/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/go-always-passing-by-value/>Goの参照渡しについて調べてみた</a></h2><time class=published datetime="2020-06-14 00:00:00 +0000 UTC">2020-06-14</time></header></article><footer><a href=/tech-blog/blog/ class=button>続きを見る</a></footer></section><section id=categories><header><h1><a href=/tech-blog/categories>Categories</a></h1></header><ul><li><a href=/tech-blog/categories/go/>go<span class=count>17</span></a><li><a href=/tech-blog/categories/%E5%8B%89%E5%BC%B7%E4%BC%9A/>勉強会<span class=count>6</span></a><li><a href=/tech-blog/categories/ddd/>ddd<span class=count>5</span></a><li><a href=/tech-blog/categories/advent-calendar/>advent-calendar<span class=count>3</span></a><li><a href=/tech-blog/categories/web-api/>web-api<span class=count>3</span></a><li><a href=/tech-blog/categories/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/>アーキテクチャ<span class=count>3</span></a><li><a href=/tech-blog/categories/%E8%AA%AD%E6%9B%B8%E3%81%BE%E3%81%A8%E3%82%81/>読書まとめ<span class=count>3</span></a><li><a href=/tech-blog/categories/html/css/>html/css<span class=count>2</span></a><li><a href=/tech-blog/categories/react/>react<span class=count>2</span></a><li><a href=/tech-blog/categories/web%E5%85%A8%E8%88%AC/>web全般<span class=count>2</span></a><li><a href=/tech-blog/categories/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3/>セキュリティ<span class=count>2</span></a><li><a href=/tech-blog/categories/%E3%83%86%E3%82%B9%E3%83%88/>テスト<span class=count>2</span></a><li><a href=/tech-blog/categories/android/>android<span class=count>1</span></a><li><a href=/tech-blog/categories/aws/>aws<span class=count>1</span></a><li><a href=/tech-blog/categories/ci/cd/>ci/cd<span class=count>1</span></a><li><a href=/tech-blog/categories/ecs/>ecs<span class=count>1</span></a><li><a href=/tech-blog/categories/firebase/>firebase<span class=count>1</span></a><li><a href=/tech-blog/categories/github/>github<span class=count>1</span></a><li><a href=/tech-blog/categories/kotlin/>kotlin<span class=count>1</span></a><li><a href=/tech-blog/categories/lint/>lint<span class=count>1</span></a><li><a href=/tech-blog/categories/podcast/>podcast<span class=count>1</span></a><li><a href=/tech-blog/categories/rds/>rds<span class=count>1</span></a><li><a href=/tech-blog/categories/terraform/>terraform<span class=count>1</span></a><li><a href=/tech-blog/categories/typescript/>typescript<span class=count>1</span></a><li><a href=/tech-blog/categories/vue.js/>vue.js<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%82%B9%E3%82%AF%E3%83%A9%E3%83%A0/>スクラム<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%83%81%E3%83%BC%E3%83%A0%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88/>チームマネジメント<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%83%9D%E3%82%A8%E3%83%A0/>ポエム<span class=count>1</span></a><li><a href=/tech-blog/categories/%E5%85%A5%E9%96%80/>入門<span class=count>1</span></a><li><a href=/tech-blog/categories/%E7%B0%A1%E5%8D%98%E3%81%BE%E3%81%A8%E3%82%81/>簡単まとめ<span class=count>1</span></a><li><a href=/tech-blog/categories/%E8%87%AA%E5%B7%B1%E7%B4%B9%E4%BB%8B/>自己紹介<span class=count>1</span></a></li></ul></section><section id=mini-bio><header><h1>About</h1></header><p>東京で働くソフトウェアエンジニアです。バックエンドがメインですが、フロントやインフラもさわっています。</p><footer><a href=/tech-blog/about class=button>もっと詳しく知る</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul><p class=copyright>© 2020 yyh-gl's Tech Blog<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.77.0 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/tech-blog/js/bundle.min.11dc02371cad2fde919e03b0002d46d9cd2420aeab5f006e3f3ae9662ba228f8.js integrity="sha256-EdwCNxytL96RngOwAC1G2c0kIK6rXwBuPzrpZiuiKPg="></script><script src=/tech-blog/js/add-on.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-140914324-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>