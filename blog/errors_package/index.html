<!doctype html><html lang=ja><head><meta charset=utf-8><title>【Golang】errorsパッケージの中身覗いてみた - yyh-gl's Tech Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/tech-blog/favicon/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/tech-blog/favicon/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/tech-blog/favicon/favicon-16x16.png?v=1"><link rel=manifest href="/tech-blog/favicon/site.webmanifest?v=1"><link rel=mask-icon href="/tech-blog/favicon/safari-pinned-tab.svg?v=1" color=#ffffff><link rel="shortcut icon" href="/tech-blog/favicon/favicon.ico?v=1"><meta name=msapplication-config content="/tech-blog/favicon/browserconfig.xml?v=1"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.77.0"><meta property="og:site_name" content="yyh-gl's Tech Blog"><meta property="og:title" content="【Golang】errorsパッケージの中身覗いてみた"><meta property="og:description" content="今回は Unwrap()，Is()，As() についてお届け"><meta property="description" content="今回は Unwrap()，Is()，As() についてお届け"><meta property="og:url" content="https://yyh-gl.github.io/tech-blog/blog/errors_package/"><meta property="og:type" content="article"><meta property="og:image" content="https://yyh-gl.github.io/tech-blog/img/main/logo.png"><link rel=stylesheet href=/tech-blog/css/bundle.min.e4a0b0705b8f8ce6273c21134a9e69bb89bd526da868b7e33bfa5fb249ba0c2b.css integrity="sha256-5KCwcFuPjOYnPCETSp5pu4m9Um2oaLfjO/pfskm6DCs="><link rel=stylesheet href=/tech-blog/css/add-on.css><script src=https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js></script><script src=/tech-blog/js/vue.min.js></script><script src=/tech-blog/js/good-counter.js defer></script></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/tech-blog/ class=nav>Blog</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/tech-blog/ class="nav link"><i class="fa fa-home"></i>Home</a>
<a href=/tech-blog/about/ class="nav link"><i class="far fa-id-card"></i>About</a>
<a href=/tech-blog/blog/ class="nav link"><i class="far fa-newspaper"></i>Blog</a>
<a href=/tech-blog/categories/ class="nav link"><i class="fas fa-sitemap"></i>Categories</a></menu>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav></header><div id=wrapper><section id=site-intro><a href=/tech-blog/><img src=https://yyh-gl.github.io/tech-blog/img/main/logo.png class=circle width=80 alt="yyh-gl's icon"></a><header><h1>yyh-gl's Tech Blog</h1></header><main><p>技術ネタ中心のブログです。主な扱いはバックエンド技術と設計です。</p></main><footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/tech-blog/blog/errors_package/>【Golang】errorsパッケージの中身覗いてみた</a></h2><p>今回は Unwrap()，Is()，As() についてお届け</p></div><div class=meta><time datetime="2020-03-09 00:00:00 +0000 UTC">2020-03-09</time><p>yyh-gl</p><p>3 分で読めます</p></div></header><div id=socnet-share></div><div class=content><a href=/tech-blog/blog/errors_package/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/03/errors_package/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/03/errors_package/featured.png alt=画像がどこかへ逝ってしまったようだ…></a><br><hr><h1 id=errorsパッケージに興味持った>errorsパッケージに興味持った</h1><hr><p>v1.13からerrorsパッケージに <code>Unwrap()</code> <code>Is()</code> <code>As()</code> といった関数が追加されました。<br>（もう1.14もリリースされているのに今さらですね😇）</p><p>今回はこれら3つの関数について、内部実装を追いかけていきます。</p><p>と、その前に、errorsパッケージの概要と関連パッケージについて軽く説明しておきます。</p><br><hr><h1 id=errorsパッケージと関連パッケージ>errorsパッケージと関連パッケージ</h1><hr><h2 id=errorsパッケージ>errorsパッケージ</h2><p>名前の通り、エラー関連の処理がまとまっているパッケージですね。<br>Goの標準パッケージです。<br>→ <a href=https://golang.org/pkg/errors/>GoDoc</a></p><p>v1.13にて、先述の <code>Unwrap()</code> <code>Is()</code> <code>As()</code> という関数たちが追加されました。<br></p><p>errorを扱うパッケージとして、もうひとつ有名なパッケージがあります。<br>xerrorsパッケージです。</p><br><h2 id=xerrorsパッケージ>xerrorsパッケージ</h2><p><a href=https://godoc.org/golang.org/x/xerrors>xerrors</a> とは、
<a href=https://godoc.org/-/subrepo>Goのサブリポジトリ</a>で開発が進められているパッケージです。<br>（準標準パッケージといった感じでしょうか）</p><p><a href=https://godoc.org/golang.org/x/xerrors>xerrorsのGoDoc</a>に下記の記述がある通り、</p><blockquote><p>These functions were incorporated into the standard library&rsquo;s errors package in Go 1.13: - Is - As - Unwrap</p></blockquote><p>もともとは本パッケージに <code>Unwrap()</code> <code>Is()</code> <code>As()</code> が実装されていましたが、<br>v1.13にて標準パッケージに取り込まれました。</p><br><p>さて、軽くerror関連のパッケージについて触れたところで、<br>早速、<code>Unwrap()</code> <code>Is()</code> <code>As()</code> の内部実装を見ていきたいと思います。<br>なお、Goのコードはv1.14.0を参照しています。</p><br><hr><h1 id=unwraphttpsgolangorgpkgerrorsunwrap><a href=https://golang.org/pkg/errors/#Unwrap>Unwrap()</a></h1><hr><p>ラップされたエラーから中身のエラーを取り出す関数です。</p><p>処理としては下記のようになっています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Unwrap</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>	<span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#66d9ef>interface</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>		<span style=color:#a6e22e>Unwrap</span>() <span style=color:#66d9ef>error</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>	})
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Unwrap</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span>}
</code></pre></div><p><a href="https://golang.org/src/errors/wrap.go?s=372:400#L14">https://golang.org/src/errors/wrap.go?s=372:400#L14</a></p><p>ぱっと見だと、ん？っとなってしまうかもしれませんが、<br>下記のように処理を分解してやると、特別難しいことは何もしていないことがわかります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Unwrap</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>    <span style=color:#75715e>// ラップされたエラーのインターフェース
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#75715e></span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>wrapErrInterface</span> <span style=color:#66d9ef>interface</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>        <span style=color:#a6e22e>Unwrap</span>() <span style=color:#66d9ef>error</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>    <span style=color:#75715e>// 型アサーションにより、ラップされたエラーのインターフェースを満たしているかチェック
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#75715e></span>	<span style=color:#a6e22e>u</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#a6e22e>wrapErrInterface</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Unwrap</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>}
</code></pre></div><p>やっていることとしては、7行目で<br>型アサーションを用いてラップされたエラーのインターフェースを満たしているかチェックし、<br>満たしていなければ（ok == false）、nilを返す。<br>満たしていれば（ok == true）、実装されている <code>Unwrap()</code> を処理するわけです。</p><p>ここで注意ですが、<br>12行目の <code>Unwrap()</code> は今まで話に出てきていた <code>errors.Unwrap()</code> とは全く別物です。</p><p>では、12行目の <code>Unwrap()</code> はどこにあるのか。
答えはerrorをラップする処理のところにあります。</p><br><h2 id=errorをラップする関数>errorをラップする関数</h2><p>errorをラップする関数である <code>fmt.Errorf()</code> の中身を見てみましょう。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Errorf</span>(<span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>	<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newPrinter</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>wrapErrs</span> = <span style=color:#66d9ef>true</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>doPrintf</span>(<span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>a</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>buf</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>wrappedErr</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>s</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	} <span style=color:#66d9ef>else</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>		<span style=color:#a6e22e>err</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wrapError</span>{<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>wrappedErr</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>free</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>}
</code></pre></div><p><a href="https://golang.org/src/fmt/errors.go?s=624:674#L17">https://golang.org/src/fmt/errors.go?s=624:674#L17</a></p><p>10行目で、<code>wrapError</code> なる構造体を返していますね。
宣言箇所に飛んでみましょう。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>wrapError</span> <span style=color:#66d9ef>struct</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>	<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>	<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>wrapError</span>) <span style=color:#a6e22e>Error</span>() <span style=color:#66d9ef>string</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>msg</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>wrapError</span>) <span style=color:#a6e22e>Unwrap</span>() <span style=color:#66d9ef>error</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>err</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>}
</code></pre></div><p><a href=https://golang.org/src/fmt/errors.go#L32>https://golang.org/src/fmt/errors.go#L32</a></p><p><code>Unwrap()</code> がありましたね。<br>wrapError構造体は内部フィールドに <code>err</code> を持っており、<br>ここにラップしたエラーを入れるわけです。<br>実際、さきほどの <code>Errorf()</code> の10行目でセットしてますよね。</p><br><p><code>errors.Unwrap()</code> はこうして実装されていたわけですね〜</p><p>どんどん行きましょう。</p><br><hr><h1 id=ishttpsgolangorgpkgerrorsis><a href=https://golang.org/pkg/errors/#Is>Is()</a></h1><hr><p>次は <code>Is()</code> を見ていきます。</p><p>本関数は2つのエラーが同じエラーかどうかを判定します。<br>また、比較元（第一引数）のエラーがラップしたエラーだったとしても、<br>最後までUnwrapして比較してくれます。</p><p>処理はこんな感じです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>target</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>bool</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>target</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#a6e22e>isComparable</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#a6e22e>target</span>).<span style=color:#a6e22e>Comparable</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#66d9ef>for</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isComparable</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>target</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>		}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#66d9ef>interface</span>{ <span style=color:#a6e22e>Is</span>(<span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>bool</span> }); <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>target</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>		}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>		
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>Unwrap</span>(<span style=color:#a6e22e>err</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>		}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>}
</code></pre></div><p>要となる処理は7〜20行明のfor文内の処理です。</p><p>まずは、8,9行目にて単純にエラー同士の比較をしています。<br>ここで一致すれば <code>return true</code> ですね。</p><p>次に11行目でerrが <code>Is(error) bool</code> という関数を持っているかどうか、<br>型アサーションによって確認しています。</p><p>本処理がなにをしているかというと、<br><u>独自の同値判定処理がないか確認し、ある場合はその同値判定処理を使用して判定を行う</u><br>ということをしてくれています。</p><p><code>Is(error) bool</code> の実装例が<a href=https://golang.org/pkg/errors/#Is>公式のドキュメント</a>にあります。<br>↓↓↓</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#a6e22e>MyError</span>) <span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>target</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>ErrExist</span> }
</code></pre></div><p>独自のエラー型を定義するときに役立ちそうですね。</p><p>では、最後に15行目からの処理です。<br>ここはerrをUnwrapする処理ですね。<br>（このUnwrap()は前章で説明した関数です）</p><p>つまり、<br><code>isComparable && err == target</code><br>および<br><code>x, ok := err.(interface{ Is(error) bool }); ok && x.Is(target)</code><br>の両条件に該当しなかった場合は、errの中にあるエラーを抜き取り、<br>そのエラーに対して、forループの最初から処理していくということになります。</p><p>この最後のUnwrap()により、<br>本章冒頭に述べた</p><blockquote><p>また、比較元（第一引数）のエラーがラップしたエラーだったとしても、<br>最後までUnwrapして比較してくれます。</p></blockquote><p>というのを実現しているわけですね。</p><br><hr><h1 id=ashttpsgolangorgpkgerrorsas><a href=https://golang.org/pkg/errors/#As>As()</a></h1><hr><p>最後に <code>As()</code> です。<br>本関数はラップされたエラーから指定のエラーを抽出します。<br>抽出できるエラーがない場合は戻り値としてfalseが返されます。</p><p>それでは内部実装を見ていきます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>target</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>target</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>		panic(<span style=color:#e6db74>&#34;errors: target cannot be nil&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>	<span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>target</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>	<span style=color:#a6e22e>typ</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>Type</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Kind</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>Ptr</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>IsNil</span>() {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>		panic(<span style=color:#e6db74>&#34;errors: target must be a non-nil pointer&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Elem</span>(); <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Kind</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>Interface</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Implements</span>(<span style=color:#a6e22e>errorType</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>		panic(<span style=color:#e6db74>&#34;errors: *target must be interface or implement error&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>	<span style=color:#a6e22e>targetType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Elem</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>AssignableTo</span>(<span style=color:#a6e22e>targetType</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>			<span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>Elem</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>err</span>))
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>		}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#66d9ef>interface</span>{ <span style=color:#a6e22e>As</span>(<span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> }); <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>target</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>		}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>Unwrap</span>(<span style=color:#a6e22e>err</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>	}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errorType</span> = <span style=color:#a6e22e>reflectlite</span>.<span style=color:#a6e22e>TypeOf</span>((<span style=color:#f92672>*</span><span style=color:#66d9ef>error</span>)(<span style=color:#66d9ef>nil</span>)).<span style=color:#a6e22e>Elem</span>()
</code></pre></div><p>for文と <code>errors.Unwrap()</code> を使って<br>ラップされたエラーの中身を取り出していくあたりは <code>Is()</code> と同じですね。</p><p>また、19行目で独自定義の <code>As()</code> を使用できるところも <code>Is()</code> と同じです。</p><p>特徴的なのは、5〜18行目の部分になります。</p><p>まず、5，6行目でreflectliteを使って第2引数のエラー（target）の構造を読み取っています。<br></p><blockquote><p>reflectliteはreflectパッケージの軽量版で、<br>runtimeおよびunsafe以外での使用は基本的に禁止されています。 &#187; <a href=https://golang.org/pkg/internal/reflectlite/#Overview>参考</a></p></blockquote><p>そして、targetがポインタである、かつ、nilでないことを確認します。<br>抽出したエラーはtargetに格納するので、targetはポインタである必要があります。<br>よって、ポインタかどうか確認しているのだと考えています。</p><p>加えて、10行目で、interfaceである、かつ、errorType（＝error）を実装できているかをチェックします。</p><p>以上で、targetがerrorを格納できる箱であるかどうかを判定しています。</p><br><p>続きの13行目以降で、<br>errがtargetに格納できる値かどうかを判定し、できるならば格納しています。（15，16行目）</p><p>格納できない場合は、独自実装の <code>As()</code> 探して、実行していますね。</p><p>err が target に格納できず、独自実装の <code>As()</code> もない場合は、<br>err を <code>Unwrap()</code> して再度同じ処理を行います。</p><p>そして、格納できるエラーがなかった場合は false を返すわけですね。</p><br><hr><h1 id=まとめ>まとめ</h1><hr><p>errorsパッケージの実装を覗いてみましたが、いかがだったでしょうか？<br>普段使ってる標準パッケージの内部実装を追いかけるのは楽しいですね〜</p><p>今回はerrorsパッケージの中身を見ましたが、reflectliteパッケージが結構使われていましたね。</p><p>reflectliteの動きが分からない部分もあったので、<br>次はreflectliteの中身も見たいなという気持ちになっています。</p><p>（reflectliteを少し覗いたのですが、Goの型のデータ構造？的な話が入ってきており、ビビってます😇）</p><p>reflectliteを一緒に読みたいって方おられたら<a href=https://twitter.com/yyh_gl>TwitterでDM</a>ください！<br>ぜひオンラインでコードリーディング会しましょう</p><br><hr><h1 id=参考文献>参考文献</h1><hr><ul><li><a href=https://golang.org/pkg/errors/>errorsパッケージの公式ドキュメント</a></li><li><a href=https://text.baldanders.info/golang/error-handling-in-go-1_3/>Go 1.13 のエラー・ハンドリング</a></li><li><a href=https://medium.com/@felipedutratine/golang-how-to-handle-errors-in-v1-13-fda7f035d027>Golang: How to handle Errors in v1.13</a></li><li><a href=https://golang.org/pkg/internal/reflectlite/>reflectliteパッケージの公式ドキュメント</a></li></ul></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/tech-blog/categories/go/>Go</a></li></ul><div><good-counter url=/tech-blog/blog/errors_package/></good-counter></div></div></footer></article><div class=pagination><a href=/tech-blog/blog/error_questions/ class="button left"><span>【Golang】errorの同値性と表示について調べた</span></a>
<a href=/tech-blog/blog/go-versions/ class="button right"><span>Goのバージョン管理について</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>最近の投稿</h1></header><article class=mini-post><a href=/tech-blog/blog/go-switch-fallthrough/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/go-switch-fallthrough/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/go-switch-fallthrough/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/go-switch-fallthrough/>【Go】Switch文のfallthroughに関するまとめ</a></h2><time class=published datetime="2020-10-03 00:00:00 +0000 UTC">2020-10-03</time></header></article><article class=mini-post><a href=/tech-blog/blog/podcast-matome-texta-200827/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/podcast-matome-texta-200827/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/10/podcast-matome-texta-200827/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/podcast-matome-texta-200827/>texta.fm #1 まとめ</a></h2><time class=published datetime="2020-10-01 00:00:00 +0000 UTC">2020-10-01</time></header></article><article class=mini-post><a href=/tech-blog/blog/go-always-passing-by-value/ class=image style="--bg-image: url('https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/06/go-always-passing-by-value/featured.png')"><img src=https://yyh-gl.github.io/tech-blog/img/tech-blog/2020/06/go-always-passing-by-value/featured.png alt=featured></a><header><h2><a href=/tech-blog/blog/go-always-passing-by-value/>Goの参照渡しについて調べてみた</a></h2><time class=published datetime="2020-06-14 00:00:00 +0000 UTC">2020-06-14</time></header></article><footer><a href=/tech-blog/blog/ class=button>続きを見る</a></footer></section><section id=categories><header><h1><a href=/tech-blog/categories>Categories</a></h1></header><ul><li><a href=/tech-blog/categories/go/>go<span class=count>17</span></a><li><a href=/tech-blog/categories/%E5%8B%89%E5%BC%B7%E4%BC%9A/>勉強会<span class=count>6</span></a><li><a href=/tech-blog/categories/ddd/>ddd<span class=count>5</span></a><li><a href=/tech-blog/categories/advent-calendar/>advent-calendar<span class=count>3</span></a><li><a href=/tech-blog/categories/web-api/>web-api<span class=count>3</span></a><li><a href=/tech-blog/categories/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/>アーキテクチャ<span class=count>3</span></a><li><a href=/tech-blog/categories/%E8%AA%AD%E6%9B%B8%E3%81%BE%E3%81%A8%E3%82%81/>読書まとめ<span class=count>3</span></a><li><a href=/tech-blog/categories/html/css/>html/css<span class=count>2</span></a><li><a href=/tech-blog/categories/react/>react<span class=count>2</span></a><li><a href=/tech-blog/categories/web%E5%85%A8%E8%88%AC/>web全般<span class=count>2</span></a><li><a href=/tech-blog/categories/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3/>セキュリティ<span class=count>2</span></a><li><a href=/tech-blog/categories/%E3%83%86%E3%82%B9%E3%83%88/>テスト<span class=count>2</span></a><li><a href=/tech-blog/categories/android/>android<span class=count>1</span></a><li><a href=/tech-blog/categories/aws/>aws<span class=count>1</span></a><li><a href=/tech-blog/categories/ci/cd/>ci/cd<span class=count>1</span></a><li><a href=/tech-blog/categories/ecs/>ecs<span class=count>1</span></a><li><a href=/tech-blog/categories/firebase/>firebase<span class=count>1</span></a><li><a href=/tech-blog/categories/github/>github<span class=count>1</span></a><li><a href=/tech-blog/categories/kotlin/>kotlin<span class=count>1</span></a><li><a href=/tech-blog/categories/lint/>lint<span class=count>1</span></a><li><a href=/tech-blog/categories/podcast/>podcast<span class=count>1</span></a><li><a href=/tech-blog/categories/rds/>rds<span class=count>1</span></a><li><a href=/tech-blog/categories/terraform/>terraform<span class=count>1</span></a><li><a href=/tech-blog/categories/typescript/>typescript<span class=count>1</span></a><li><a href=/tech-blog/categories/vue.js/>vue.js<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%82%B9%E3%82%AF%E3%83%A9%E3%83%A0/>スクラム<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%83%81%E3%83%BC%E3%83%A0%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88/>チームマネジメント<span class=count>1</span></a><li><a href=/tech-blog/categories/%E3%83%9D%E3%82%A8%E3%83%A0/>ポエム<span class=count>1</span></a><li><a href=/tech-blog/categories/%E5%85%A5%E9%96%80/>入門<span class=count>1</span></a><li><a href=/tech-blog/categories/%E7%B0%A1%E5%8D%98%E3%81%BE%E3%81%A8%E3%82%81/>簡単まとめ<span class=count>1</span></a><li><a href=/tech-blog/categories/%E8%87%AA%E5%B7%B1%E7%B4%B9%E4%BB%8B/>自己紹介<span class=count>1</span></a></li></ul></section><section id=mini-bio><header><h1>About</h1></header><p>東京で働くソフトウェアエンジニアです。バックエンドがメインですが、フロントやインフラもさわっています。</p><footer><a href=/tech-blog/about class=button>もっと詳しく知る</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul><p class=copyright>© 2020 yyh-gl's Tech Blog<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.77.0 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/tech-blog/js/bundle.min.11dc02371cad2fde919e03b0002d46d9cd2420aeab5f006e3f3ae9662ba228f8.js integrity="sha256-EdwCNxytL96RngOwAC1G2c0kIK6rXwBuPzrpZiuiKPg="></script><script src=/tech-blog/js/add-on.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-140914324-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>