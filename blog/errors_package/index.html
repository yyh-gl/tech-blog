<!doctype html><html lang=ja><head><meta charset=utf-8><title>【Go】errorsパッケージの中身覗いてみた - yyh-gl's Tech Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/favicon/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/favicon/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/favicon/favicon-16x16.png?v=1"><link rel=manifest href="/favicon/site.webmanifest?v=1"><link rel=mask-icon href="/favicon/safari-pinned-tab.svg?v=1" color=#ffffff><link rel="shortcut icon" href="/favicon/favicon.ico?v=1"><meta name=msapplication-config content="/favicon/browserconfig.xml?v=1"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.109.0"><meta property="og:site_name" content="yyh-gl's Tech Blog"><meta property="og:title" content="【Go】errorsパッケージの中身覗いてみた"><meta property="og:description" content="今回は Unwrap()，Is()，As() についてお届け"><meta property="description" content="今回は Unwrap()，Is()，As() についてお届け"><meta property="og:url" content="https://tech.yyh-gl.dev/blog/errors_package/"><meta property="og:type" content="article"><meta property="og:image" content="https://tech.yyh-gl.dev/img/2020/03/errors_package/featured.webp"><meta property="og:image:alt" content="featured"><link rel=stylesheet href=/css/bundle.min.eecc4098b778083eae3bb22681e71b028b3fcaeb1e2d9aa074ac7327cd7ecea0.css integrity="sha256-7sxAmLd4CD6uO7ImgecbAos/yuseLZqgdKxzJ81+zqA="><link rel=stylesheet href=/css/add-on.css><link rel=stylesheet href=/css/prism.css><link rel=alternate type=application/atom+xml title=Atom href=/index.xml><script src=https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js></script>
<script src=/js/vue.min.js></script>
<script src=/js/good-counter.js defer></script></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/ class=nav>Blog</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/ class="nav link"><i class='fa fa-home'></i> Home</a>
<a href=/about/ class="nav link"><i class='far fa-id-card'></i> About</a>
<a href=/blog/ class="nav link"><i class='far fa-newspaper'></i> Blog</a>
<a href=/categories/ class="nav link"><i class='fas fa-sitemap'></i> Categories</a></menu>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav></header><div id=wrapper><section id=site-intro><a href=/><img src=https://tech.yyh-gl.dev/img/main/logo.webp class=circle width=80 alt="yyh-gl's icon"></a><header><h1>yyh-gl's Tech Blog</h1></header><main><p>技術ネタ中心のブログです。主な扱いはバックエンド技術と設計です。</p></main><footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//www.linkedin.com/in/yyh-gl target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=//speakerdeck.com/yyh_gl target=_blank title="Speaker Deck" class="fab fa-speaker-deck"></a></li><li><a href=//crowdin.com/profile/yyh-gl target=_blank title=Crowdin class="fas fa-pen-square"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/blog/errors_package/>【Go】errorsパッケージの中身覗いてみた</a></h2><p>今回は Unwrap()，Is()，As() についてお届け</p></div><div class=meta><time datetime="2020-03-09 09:00:00 +0900 +0900">2020-03-09</time><p>yyh-gl</p><p>3 分で読めます</p></div></header><div id=socnet-share></div><div class=content><a href=/blog/errors_package/ class=image style="--bg-image:url('https://tech.yyh-gl.dev/img/2020/03/errors_package/featured.webp')"><img src=https://tech.yyh-gl.dev/img/2020/03/errors_package/featured.webp alt=featured></a><h1 id=errorsパッケージに興味持った>errorsパッケージに興味持った</h1><p>v1.13からerrorsパッケージに <code>Unwrap()</code> <code>Is()</code> <code>As()</code> といった関数が追加されました。<br>（もう1.14もリリースされているのに今さらですね😇）</p><p>今回はこれら3つの関数について、内部実装を追いかけていきます。</p><p>と、その前に、errorsパッケージの概要と関連パッケージについて軽く説明しておきます。</p><h1 id=errorsパッケージと関連パッケージ>errorsパッケージと関連パッケージ</h1><h2 id=errorsパッケージ>errorsパッケージ</h2><p>名前の通り、エラー関連の処理がまとまっているパッケージですね。<br>Goの標準パッケージです。<br>→ <a href=https://golang.org/pkg/errors/ target=_blank rel="noopener noreferrer">GoDoc</a></p><p>v1.13にて、先述の <code>Unwrap()</code> <code>Is()</code> <code>As()</code> という関数たちが追加されました。<br></p><p>errorを扱うパッケージとして、もうひとつ有名なパッケージがあります。<br>xerrorsパッケージです。</p><h2 id=xerrorsパッケージ>xerrorsパッケージ</h2><p><a href=https://godoc.org/golang.org/x/xerrors target=_blank rel="noopener noreferrer">xerrors</a>
とは、
<a href=https://godoc.org/-/subrepo target=_blank rel="noopener noreferrer">Goのサブリポジトリ</a>
で開発が進められているパッケージです。<br>（準標準パッケージといった感じでしょうか）</p><p><a href=https://godoc.org/golang.org/x/xerrors target=_blank rel="noopener noreferrer">xerrorsのGoDoc</a>
に下記の記述がある通り、</p><blockquote><p>These functions were incorporated into the standard library&rsquo;s errors package in Go 1.13: - Is - As - Unwrap</p></blockquote><p>もともとは本パッケージに <code>Unwrap()</code> <code>Is()</code> <code>As()</code> が実装されていましたが、<br>v1.13にて標準パッケージに取り込まれました。</p><br><p>さて、軽くerror関連のパッケージについて触れたところで、<br>早速、<code>Unwrap()</code> <code>Is()</code> <code>As()</code> の内部実装を見ていきたいと思います。<br>なお、Goのコードはv1.14.0を参照しています。</p><h1 id=unwraphttpsgolangorgpkgerrorsunwrap><a href=https://golang.org/pkg/errors/#Unwrap target=_blank rel="noopener noreferrer">Unwrap()</a></h1><p>ラップされたエラーから中身のエラーを取り出す関数です。</p><p>処理としては下記のようになっています。</p><pre class=line-numbers><code class=language-go>func Unwrap(err error) error {
	u, ok := err.(interface {
		Unwrap() error
	})
	if !ok {
		return nil
	}
	return u.Unwrap()
}
</code></pre><p><a href="https://golang.org/src/errors/wrap.go?s=372:400#L14" target=_blank rel="noopener noreferrer">https://golang.org/src/errors/wrap.go?s=372:400#L14</a></p><p>ぱっと見だと、ん？っとなってしまうかもしれませんが、<br>下記のように処理を分解してやると、特別難しいことは何もしていないことがわかります。</p><pre class=line-numbers><code class=language-go>func Unwrap(err error) error {
    // ラップされたエラーのインターフェース
    type wrapErrInterface interface {
        Unwrap() error
    }

    // 型アサーションにより、ラップされたエラーのインターフェースを満たしているかチェック
	u, ok := err.(wrapErrInterface)
	if !ok {
		return nil
	}
	return u.Unwrap()
}
</code></pre><p>処理を順に追っていくと、
7行目で型アサーションを用いてラップされたエラーのインターフェースを満たしているかチェックし、
満たしていなければ（ok == false）nilを返します。<br>満たしていれば（ok == true）実装されている <code>Unwrap()</code> を処理します。</p><p>ここで注意ですが、
12行目の <code>Unwrap()</code> は今まで話に出てきていた <code>errors.Unwrap()</code> とは全くの別物です。<br>では、12行目の <code>Unwrap()</code> はどこにあるのか。<br>答えはerrorをラップする処理のところにあります。</p><h2 id=errorをラップする関数>errorをラップする関数</h2><p>errorをラップする関数である <code>fmt.Errorf()</code> の中身を見てみましょう。</p><pre class=line-numbers><code class=language-go>func Errorf(format string, a ...interface{}) error {
	p := newPrinter()
	p.wrapErrs = true
	p.doPrintf(format, a)
	s := string(p.buf)
	var err error
	if p.wrappedErr == nil {
		err = errors.New(s)
	} else {
		err = &amp;wrapError{s, p.wrappedErr}
	}
	p.free()
	return err
}
</code></pre><p><a href="https://golang.org/src/fmt/errors.go?s=624:674#L17" target=_blank rel="noopener noreferrer">https://golang.org/src/fmt/errors.go?s=624:674#L17</a></p><p>10行目で、<code>wrapError</code> という構造体を返していますね。<br>宣言箇所に飛んでみましょう。</p><pre class=line-numbers><code class=language-go>type wrapError struct {
	msg string
	err error
}

func (e *wrapError) Error() string {
	return e.msg
}

func (e *wrapError) Unwrap() error {
	return e.err
}
</code></pre><p><a href=https://golang.org/src/fmt/errors.go#L32 target=_blank rel="noopener noreferrer">https://golang.org/src/fmt/errors.go#L32</a></p><p><code>Unwrap()</code> がありました。</p><p>まず、<code>wrapError</code>構造体ですが、本構造体は<code>err</code>フィールドを持っており、ここにラップするエラーを格納しています。<br>（さきほど見た <code>Errorf()</code> の内部処理では、10行目にて<code>wrapError</code>が使用されています）</p><p><code>Unwrap()</code>は<code>wrapError</code>構造体の<code>err</code>フィールド、すなわち、ラップしていたエラーを返しているだけですね。</p><br><p>以上、<code>errors.Unwrap()</code> の内部実装はこんな感じでした。</p><p>どんどん行きましょう。</p><h1 id=ishttpsgolangorgpkgerrorsis><a href=https://golang.org/pkg/errors/#Is target=_blank rel="noopener noreferrer">Is()</a></h1><p>次は <code>Is()</code> を見ていきます。</p><p>本関数は2つのエラーが同じエラーかどうかを判定します。<br>また、比較元（第一引数）のエラーがラップしたエラーだったとしても、<br>最後までUnwrapして比較してくれます。</p><p>処理はこんな感じです。</p><pre class=line-numbers><code class=language-go>func Is(err, target error) bool {
    if target == nil {
		return err == target
	}

	isComparable := reflectlite.TypeOf(target).Comparable()
	for {
		if isComparable &amp;&amp; err == target {
			return true
		}
		if x, ok := err.(interface{ Is(error) bool }); ok &amp;&amp; x.Is(target) {
			return true
		}
		
		if err = Unwrap(err); err == nil {
			return false
		}
	}
}
</code></pre><p>要となる処理は7〜20行明のfor文内の処理です。</p><p>まずは、8,9行目にて単純にエラー同士の比較をしています。<br>ここで一致すれば <code>return true</code> ですね。</p><p>次に11行目で、型アサーションを利用して <code>err</code>が <code>Is(error) bool</code> という関数を実装しているかチェックしています。</p><p>このチェック処理は、
<u>独自の同値判定処理がないか確認し、ある場合はその同値判定処理を使用して判定を行う</u><br>ために用意されています。</p><p><code>Is(error) bool</code> の実装例が<a href=https://golang.org/pkg/errors/#Is target=_blank rel="noopener noreferrer">公式のドキュメント</a>
にあります。<br></p><p>↓↓↓</p><pre class=line-numbers><code class=language-go>func (m MyError) Is(target error) bool { return target == os.ErrExist }
</code></pre><p>独自のエラー型を定義するときに役立ちそうですね。</p><p>では、最後に15行目からの処理です。<br>ここは<code>err</code>をUnwrapする処理ですね。<br>（この<code>Unwrap()</code>は前章で説明した関数です）</p><p>つまり、<br><code>isComparable && err == target</code><br>および<br><code>x, ok := err.(interface{ Is(error) bool }); ok && x.Is(target)</code><br>の両条件に該当しなかった場合は、<code>err</code>の中にあるエラーを抜き取り、<br>そのエラーに対して、forループの最初から処理していくということになります。</p><p>この最後の<code>Unwrap()</code>により、本章冒頭に述べた</p><blockquote><p>また、比較元（第一引数）のエラーがラップしたエラーだったとしても、<br>最後までUnwrapして比較してくれます。</p></blockquote><p>というのを実現しているわけですね。</p><h1 id=ashttpsgolangorgpkgerrorsas><a href=https://golang.org/pkg/errors/#As target=_blank rel="noopener noreferrer">As()</a></h1><p>最後に <code>As()</code> です。</p><p>本関数は、第一引数のエラーが第二引数のエラーに代入可能であれば代入し、trueを返します。<br>代入できない場合はfalseが返されます。</p><p>第二引数はポインタ型なので、<code>target</code>に関して副作用を含む関数です。</p><p>それでは内部実装を見ていきます。</p><pre class=line-numbers><code class=language-go>func As(err error, target interface{}) bool {
	if target == nil {
		panic(&quot;errors: target cannot be nil&quot;)
	}
	val := reflectlite.ValueOf(target)
	typ := val.Type()
	if typ.Kind() != reflectlite.Ptr || val.IsNil() {
		panic(&quot;errors: target must be a non-nil pointer&quot;)
	}
	if e := typ.Elem(); e.Kind() != reflectlite.Interface &amp;&amp; !e.Implements(errorType) {
		panic(&quot;errors: *target must be interface or implement error&quot;)
	}
	targetType := typ.Elem()
	for err != nil {
		if reflectlite.TypeOf(err).AssignableTo(targetType) {
			val.Elem().Set(reflectlite.ValueOf(err))
			return true
		}
		if x, ok := err.(interface{ As(interface{}) bool }); ok &amp;&amp; x.As(target) {
			return true
		}
		err = Unwrap(err)
	}
	return false
}

var errorType = reflectlite.TypeOf((*error)(nil)).Elem()
</code></pre><p>for文と <code>errors.Unwrap()</code> を使って<br>ラップされたエラーの中身を取り出していくあたりは <code>Is()</code> と同じですね。<br>加えて、19行目で独自定義の <code>As()</code> を使用できるところも <code>Is()</code> と同じです。</p><p>特徴的なのは、5〜18行目の部分になります。</p><p>まず、5，6行目でreflectliteを使って第二引数の<code>target</code>の構造を読み取っています。<br></p><blockquote><p>reflectliteはreflectパッケージの軽量版で、<br>runtimeおよびunsafe以外での使用は基本的に禁止されています。 &#187; <a href=https://golang.org/pkg/internal/reflectlite/#Overview target=_blank rel="noopener noreferrer">参考</a></p></blockquote><p>そして、<code>target</code>がポインタである、かつ、nilでないことを確認します。</p><p>本章冒頭でも述べましたが、<br>最終的に（代入可能であれば）第一引数の<code>err</code>は第二引数の<code>target</code>に格納します。<br>つまり、戻り値で<code>target</code>に格納したエラーを返すのではなく、<code>target</code>（ポインタ）経由でできあがったエラーを返します。<br>したがって、ポインタであることを確認する必要があります。</p><p>加えて、10行目で、interfaceである、かつ、errorType（＝error）を実装できているかチェックします。</p><p>以上で、<code>target</code>が<code>error</code>を格納できる箱であるか（<code>error</code>インタフェースを満たしているか）どうかを判定しています。</p><br><p>続きの13行目以降で、<br><code>err</code>が<code>target</code>に格納できる値かどうかを判定し、できるならば格納しています。（15，16行目）</p><p>格納できない場合は、独自実装の <code>As()</code> 探して、実行していますね。</p><p><code>err</code> が <code>target</code> に格納できず、独自実装の <code>As()</code> もない場合は、<br><code>err</code> を <code>Unwrap()</code> して再度同じ処理を行います。</p><p>それでも、格納できるエラーがなかった場合は false を返します。</p><h1 id=まとめ>まとめ</h1><p>errorsパッケージの実装を覗いてみましたが、いかがだったでしょうか？<br>普段使ってる標準パッケージの内部実装を追いかけるのは楽しいですね👍</p><p>今回はerrorsパッケージの中身を見ましたが、reflectliteパッケージが結構使われていましたね。</p><p>reflectliteの動きが分からない部分もあったので、<br>次はreflectliteの中身も見たいなという気持ちになっています。</p><p>（reflectliteを少し覗いたのですが、Goの型のデータ構造？的な話が入ってきており、かなりおもしろそう）</p><p>reflectliteを一緒に読みたいって方おられたら<a href=https://twitter.com/yyh_gl target=_blank rel="noopener noreferrer">TwitterでDM</a>
ください！<br>ぜひオンラインでコードリーディング会しましょう</p><h1 id=参考文献>参考文献</h1><ul><li><a href=https://golang.org/pkg/errors/ target=_blank rel="noopener noreferrer">errorsパッケージの公式ドキュメント</a></li><li><a href=https://text.baldanders.info/golang/error-handling-in-go-1_3/ target=_blank rel="noopener noreferrer">Go 1.13 のエラー・ハンドリング</a></li><li><a href=https://medium.com/@felipedutratine/golang-how-to-handle-errors-in-v1-13-fda7f035d027 target=_blank rel="noopener noreferrer">Golang: How to handle Errors in v1.13</a></li><li><a href=https://golang.org/pkg/internal/reflectlite/ target=_blank rel="noopener noreferrer">reflectliteパッケージの公式ドキュメント</a></li></ul></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/categories/go/>Go</a></li></ul><div><good-counter rel-permalink=/blog/errors_package/></good-counter></div></div></footer><div class=fix><a href="https://github.com/yyh-gl/tech-blog/issues/new?template=fix_proposal.md&assignees=yyh-gl&title=修正提案：『%e3%80%90Go%e3%80%91errors%e3%83%91%e3%83%83%e3%82%b1%e3%83%bc%e3%82%b8%e3%81%ae%e4%b8%ad%e8%ba%ab%e8%a6%97%e3%81%84%e3%81%a6%e3%81%bf%e3%81%9f』" target=_blank rel="noopener noreferrer">修正提案</a></div></article><div class=pagination><a href=/blog/error_questions/ class="button left"><span>【Go】errorの同値性と表示について調べた</span></a>
<a href=/blog/go-versions/ class="button right"><span>Goのバージョン管理について</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>最近の投稿</h1></header><article class=mini-post><a href=/blog/kotlin-ktor-stripe-tutorial/ class=image style="--bg-image:url('https://tech.yyh-gl.dev/img/2022/12/kotlin-ktor-stripe-tutorial/featured.webp')"><img src=https://tech.yyh-gl.dev/img/2022/12/kotlin-ktor-stripe-tutorial/featured.webp alt=featured></a><header><h2><a href=/blog/kotlin-ktor-stripe-tutorial/>KtorとStripeでECサイトを作ってみた</a></h2><time class=published datetime="2022-12-21 00:00:00 +0900 +0900">2022-12-21</time></header></article><article class=mini-post><a href=/blog/docker-compose-override/ class=image style="--bg-image:url('https://tech.yyh-gl.dev/img/2022/03/docker-compose-override/featured.webp')"><img src=https://tech.yyh-gl.dev/img/2022/03/docker-compose-override/featured.webp alt=featured></a><header><h2><a href=/blog/docker-compose-override/>複数のdocker-compose.ymlを使って、設定の追加や上書きをやってみる</a></h2><time class=published datetime="2022-03-19 00:55:40 +0900 +0900">2022-03-19</time></header></article><article class=mini-post><a href=/blog/activity-2021/ class=image style="--bg-image:url('https://tech.yyh-gl.dev/img/2022/01/activity-2021/featured.webp')"><img src=https://tech.yyh-gl.dev/img/2022/01/activity-2021/featured.webp alt=featured></a><header><h2><a href=/blog/activity-2021/>【2021年】アクティビティまとめ</a></h2><time class=published datetime="2022-01-02 20:59:04 +0900 +0900">2022-01-02</time></header></article><footer><a href=/blog/ class=button>続きを見る</a></footer></section><section id=mini-bio><header><h1>About</h1></header><p>東京で働くソフトウェアエンジニアです。バックエンドがメインですが、フロントやインフラもさわっています。</p><footer><a href=/about class=button>もっと詳しく知る</a></footer></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/yyh-gl target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//www.linkedin.com/in/yyh-gl target=_blank rel=noopener title=LinkedIn class="fab fa-linkedin"></a></li><li><a href=//twitter.com/yyh_gl target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li><li><a href=//speakerdeck.com/yyh_gl target=_blank title="Speaker Deck" class="fab fa-speaker-deck"></a></li><li><a href=//crowdin.com/profile/yyh-gl target=_blank title=Crowdin class="fas fa-pen-square"></a></li></ul><p class=copyright>© 2022 yyh-gl's Tech Blog<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.109.0 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a>
<script src=/js/bundle.min.3ae2ce1efda88261d882e759310edb92f3f0a7186b06c5fd92aa30f8931ab94c.js integrity="sha256-OuLOHv2ogmHYgudZMQ7bkvPwpxhrBsX9kqow+JMauUw="></script>
<script src=/js/add-on.js></script>
<script src=/js/prism.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-140914324-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>