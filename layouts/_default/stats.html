{{ define "main" }}
<article class="post">
  {{ .Render "header" }}
  <div class="content">
    {{ .Content }}

    {{ $blogPages := where .Site.RegularPages "Section" "blog" }}
    {{ $totalPosts := len $blogPages }}

    {{/* ã‚«ãƒ†ã‚´ãƒªãƒ¼é›†è¨ˆ */}}
    {{ $categoryMap := dict }}
    {{ range $blogPages }}
      {{ range .Params.categories }}
        {{ $count := index $categoryMap . | default 0 }}
        {{ $categoryMap = merge $categoryMap (dict . (add $count 1)) }}
      {{ end }}
    {{ end }}

    {{/* å¹´ã”ã¨ã®æŠ•ç¨¿æ•°é›†è¨ˆ */}}
    {{ $yearMap := dict }}
    {{ range $blogPages }}
      {{ if .Date }}
        {{ $year := .Date.Format "2006" }}
        {{ $count := index $yearMap $year | default 0 }}
        {{ $yearMap = merge $yearMap (dict $year (add $count 1)) }}
      {{ end }}
    {{ end }}

    {{/* æ–‡å­—æ•°é›†è¨ˆ */}}
    {{ $totalChars := 0 }}
    {{ $postWithContent := 0 }}
    {{ range $blogPages }}
      {{ $content := .Plain }}
      {{ $chars := len $content }}
      {{ if gt $chars 0 }}
        {{ $totalChars = add $totalChars $chars }}
        {{ $postWithContent = add $postWithContent 1 }}
      {{ end }}
    {{ end }}
    {{ $avgChars := 0 }}
    {{ if gt $postWithContent 0 }}
      {{ $avgChars = div $totalChars $postWithContent }}
    {{ end }}

    {{/* ã‚¿ã‚°é›†è¨ˆ */}}
    {{ $tagMap := dict }}
    {{ range $blogPages }}
      {{ range .Params.tags }}
        {{ $count := index $tagMap . | default 0 }}
        {{ $tagMap = merge $tagMap (dict . (add $count 1)) }}
      {{ end }}
    {{ end }}

    <section class="stats-section">
      <h2>ğŸ“Š åŸºæœ¬çµ±è¨ˆ</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ç·æŠ•ç¨¿æ•°</div>
          <div class="stat-value">{{ $totalPosts }}</div>
          <div class="stat-unit">è¨˜äº‹</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¹³å‡æ–‡å­—æ•°</div>
          <div class="stat-value">{{ $avgChars }}</div>
          <div class="stat-unit">æ–‡å­—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ç·æ–‡å­—æ•°</div>
          <div class="stat-value">{{ $totalChars }}</div>
          <div class="stat-unit">æ–‡å­—</div>
        </div>
      </div>
    </section>

    <section class="stats-section">
      <h2>ğŸ“… å¹´åˆ¥æŠ•ç¨¿æ•°</h2>
      <div class="chart-container">
        <table class="stats-table">
          <thead>
            <tr>
              <th>å¹´</th>
              <th>æŠ•ç¨¿æ•°</th>
              <th>å‰²åˆ</th>
              <th>ã‚°ãƒ©ãƒ•</th>
            </tr>
          </thead>
          <tbody>
            {{ range $year, $count := $yearMap }}
            {{ $percentage := div (mul $count 100.0) (float $totalPosts) }}
            <tr>
              <td class="year-cell">{{ $year }}</td>
              <td class="count-cell">{{ $count }}</td>
              <td class="percentage-cell">{{ printf "%.1f" $percentage }}%</td>
              <td class="bar-cell">
                <div class="bar-container">
                  <div class="bar" style="width: {{ $percentage }}%"></div>
                </div>
              </td>
            </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
    </section>

    <section class="stats-section">
      <h2>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥çµ±è¨ˆ</h2>
      <div class="chart-container">
        <table class="stats-table">
          <thead>
            <tr>
              <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
              <th>è¨˜äº‹æ•°</th>
              <th>å‰²åˆ</th>
              <th>ã‚°ãƒ©ãƒ•</th>
            </tr>
          </thead>
          <tbody>
            {{ range $category, $count := $categoryMap }}
            {{ $percentage := div (mul $count 100.0) (float $totalPosts) }}
            <tr>
              <td class="category-cell">
                <a href="{{ path.Join "categories" ($category | urlize | lower) | relLangURL }}/">{{ $category }}</a>
              </td>
              <td class="count-cell">{{ $count }}</td>
              <td class="percentage-cell">{{ printf "%.1f" $percentage }}%</td>
              <td class="bar-cell">
                <div class="bar-container">
                  <div class="bar" style="width: {{ $percentage }}%"></div>
                </div>
              </td>
            </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
    </section>

    <section class="stats-section">
      <h2>ğŸ“ˆ æ–‡å­—æ•°åˆ†å¸ƒ</h2>
      {{ $ranges := slice
        (dict "label" "ï½1000æ–‡å­—" "min" 0 "max" 1000)
        (dict "label" "1001ï½3000æ–‡å­—" "min" 1001 "max" 3000)
        (dict "label" "3001ï½5000æ–‡å­—" "min" 3001 "max" 5000)
        (dict "label" "5001ï½10000æ–‡å­—" "min" 5001 "max" 10000)
        (dict "label" "10001æ–‡å­—ï½" "min" 10001 "max" 999999999)
      }}

      <div class="chart-container">
        <table class="stats-table">
          <thead>
            <tr>
              <th>æ–‡å­—æ•°ç¯„å›²</th>
              <th>è¨˜äº‹æ•°</th>
              <th>å‰²åˆ</th>
              <th>ã‚°ãƒ©ãƒ•</th>
            </tr>
          </thead>
          <tbody>
            {{ range $rangeItem := $ranges }}
              {{ $count := 0 }}
              {{ $minChars := $rangeItem.min }}
              {{ $maxChars := $rangeItem.max }}
              {{ range $blogPages }}
                {{ $chars := len .Plain }}
                {{ if and (ge $chars $minChars) (le $chars $maxChars) }}
                  {{ $count = add $count 1 }}
                {{ end }}
              {{ end }}
              {{ $percentage := 0.0 }}
              {{ if gt $totalPosts 0 }}
                {{ $percentage = div (mul $count 100.0) (float $totalPosts) }}
              {{ end }}
              <tr>
                <td class="range-cell">{{ $rangeItem.label }}</td>
                <td class="count-cell">{{ $count }}</td>
                <td class="percentage-cell">{{ printf "%.1f" $percentage }}%</td>
                <td class="bar-cell">
                  <div class="bar-container">
                    <div class="bar" style="width: {{ $percentage }}%"></div>
                  </div>
                </td>
              </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
    </section>

    <section class="stats-section">
      <h2>ğŸ“ æœ€è¿‘ã®æŠ•ç¨¿</h2>
      <div class="recent-posts">
        {{ range first 10 (sort $blogPages "Date" "desc") }}
        <div class="recent-post-item">
          <span class="post-date">{{ .Date.Format "2006-01-02" }}</span>
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          <span class="post-chars">({{ len .Plain }} æ–‡å­—)</span>
        </div>
        {{ end }}
      </div>
    </section>

    <section class="stats-section">
      <h2>ğŸ“ æ–‡å­—æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° (ãƒˆãƒƒãƒ—10)</h2>
      <div class="ranking-list">
        {{ $sortedByChars := sort $blogPages ".Plain" "desc" }}
        {{ range first 10 $sortedByChars }}
        <div class="ranking-item">
          <span class="rank-chars">{{ len .Plain }} æ–‡å­—</span>
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          <span class="post-date">{{ .Date.Format "2006-01-02" }}</span>
        </div>
        {{ end }}
      </div>
    </section>

  </div>
</article>
{{ end }}
