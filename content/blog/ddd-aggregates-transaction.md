+++
author = "yyh-gl"
categories = ["アーキテクチャ", "DDD"]
date = "2020-02-18"
description = "「データの一貫性の境界」を見極めよう！"
featured = "ddd-aggregates-transaction/featured.png"
featuredalt = "画像がどこかへ逝ってしまったようだ…"
featuredpath = "date"
linktitle = ""
title = "【DDD】集約とトランザクション境界について調べたことメモ"
type = "post"

+++


<br>

---
# 簡単まとめシリーズ
---

今回は <b>集約とトランザクション境界</b> について、<br>
自分のわからないところを調べたので、メモとして残しておきます。

<br>

---
# 集約
---

集約の説明を[『ドメイン駆動設計入門 ボトムアップでわかる! ドメイン駆動設計の基本』](https://www.amazon.co.jp/gp/product/479815072X)から拝借すると、<br>
「データを変更するための単位として扱われるオブジェクトの集まりを集約といいます」とのこと。

↓ もうすこし具体的に言うと

DDDではエンティティと値オブジェクトというものがありますが、<br>
値オブジェクトを直接触らず、
エンティティ経由でしか変更しないようにするというものですね。

このような制限をかけることで、<br>
<b>ひとまとまりにされたオブジェクト間で維持されるべき不変条件を守ることができます。</b>

<br>

---
# トランザクション境界
---

基本的な考えとしては、集約ごとにトランザクションを貼ります。<br>

↑この基本を守るためにも、理想としては正しいモデリングにより、<br>
正しいトランザクション境界を見つけることが大事です。

正しいトランザクション境界を見つけることは、不用意に大きなDBロックの発生を防止します。

<br>

しかしながら、集約をまたいでトランザクション制御したくなるときもあります。<br>
→ 例：https://kbigwheel.hateblo.jp/entry/2018/12/03/aggregate-and-consistency

こういうときにどうするか、上記リンクでもいくつかの方法が挙げられています。<br>
他のサイトも調べてみましたが、だいたい同じような方法が出てきました。

1. 結果整合性
  - 主流っぽい
     - いろいろなサイト、書籍の中で紹介されていました
  - 整合性を担保するための仕組みづくりが必要
     - 整合性をチェックするためのバッチ など
1. 集約をまたいでトランザクションを貼る
  - 下記理由のためにあまり推奨されない
     - ロック範囲が大きくなってしまう
     - 守るべき「データの一貫性の境界」をコード上で表現できなくなる
         - 参考：https://www.pospome.work/entry/20161023/1477206615
1. 複数の集約をさらにまとめた集約をつくる
  - ロック範囲が大きくなってしまうため、あまり推奨されない

<br>

---
# 結果整合性
---

結果整合性については、<br>
[『ドメイン駆動設計入門 ボトムアップでわかる! ドメイン駆動設計の基本』](https://www.amazon.co.jp/gp/product/479815072X)の <br>
12章3説「集約の大きさと操作の単位」で言及されているので、もう少しだけ詳しく調べました。

結果整合性とは、最終的に整合性の取れていればOKという考え方。<br>
したがって、整合性が取れていない状況が起こり得るが、それは許容する。

「最終的に整合性を取る」ってどうやるの？<br>
→ [こちら](https://qiita.com/j5ik2o/items/ae8a4d3cdaa24afe7599#%E8%A7%A3%E6%B1%BA%E7%AD%962-%E4%B8%80%E6%99%82%E7%9A%84%E3%81%AA%E6%95%B4%E5%90%88%E6%80%A7%E3%81%AE%E7%A0%B4%E7%B6%BB%E3%82%92%E5%8F%97%E3%81%91%E5%85%A5%E3%82%8C%E7%B5%90%E6%9E%9C%E6%95%B4%E5%90%88%E6%80%A7%E3%82%92%E4%BD%BF%E3%81%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
が参考になる。

<br>

---
# まとめ
---

設計周りの話は、唯一無二の答えがあるわけではありません。

よって、今回の話においても「データの一貫性の境界」を意識し、<br>
ちゃんとメリットとデメリットを理解した上で最善の解を選択する必要がありますね。<br>

<br>

---
# 参考資料
---

- [ドメイン駆動設計入門 ボトムアップでわかる! ドメイン駆動設計の基本](https://www.amazon.co.jp/gp/product/479815072X)
- [DDDにおいて、なぜ複数の集約にまたがってトランザクションをかけてはいけないのか（multiple aggregates in one transaction）](https://www.pospome.work/entry/20161023/1477206615)
- [集約とトランザクション境界に関するメモ](https://dnskimox.hateblo.jp/entry/2018/12/22/154038)
- [集約の境界と整合性の維持の仕方に悩んで2ヶ月ぐらい結論を出せていない話](https://kbigwheel.hateblo.jp/entry/2018/12/03/aggregate-and-consistency)
- [集約の境界と整合性問題に関する感想](https://qiita.com/j5ik2o/items/ae8a4d3cdaa24afe7599)

テスト
